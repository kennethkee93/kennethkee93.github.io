<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Emerald Hills EV Charger Reservation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <base target="_top">

  <!-- PWA Manifest and Icons (from original github.io file) -->
  <link rel="manifest" href="/assets/images/favicons/site.webmanifest">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicons/favicon-16x16.png">
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
	
  <!-- External Libraries (from GAS files) -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.18/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.18/index.global.min.js"></script>
	
  <!-- ALL CSS IS NOW INCLUDED HERE (from styles.txt) -->
  <style>
    /* ===== GLOBAL STYLES ===== */
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        max-width: 100vw;
        overflow-y: hidden;
        background: #FFFFFF;
        font-family: 'Poppins', Arial, sans-serif;
        color: #000;
        box-sizing: border-box;
    }

    #mainAppWrapper {
        display: flex; 
        flex-direction: column;
        height: 100vh; 
        overflow: hidden;
        touch-action: pan-y;
        background: 
    }

    /* ===== HEADER STYLES ===== */
    #appHeader {
        display: flex;
        flex: 0 0 auto;
        justify-content: center;
        align-items: center;
        padding: 10px;
        text-align: center;
        z-index: 10;
        transition: all 0.3s ease;
        overflow: hidden; /* Hide content that overflows when shrinking */
    }

    #appHeader.header-shrink {
        transform: translateY(-50px) scaleY(0.5); /* Very thin vertically, narrow horizontally */
        opacity: 0.8;
        padding: 1px 5px;
        height: 5px; /* Force a very small height */
    }

    #appHeader.header-shrink h1 {
        font-size: 0.2em; /* Nearly invisible text */
        transition: all 0.3s ease;
    }

    h1 {
        color: #111827 ;
        margin-bottom: 20px;
        text-align: center;
    }

    /* ===== TAB SYSTEM ===== */
    #tabButtons {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: #111827; /* New background color (unchanged) */
        box-shadow: 0 -2px 10px #111827;
        display: flex;
        justify-content: space-around;
        gap: 12px;
        padding: 10px 0;
        z-index: 999;
        border-radius: 25px 25px 0 0;
        padding-bottom: env(safe-area-inset-bottom); /* iOS Safe Area */
    }

    .tab-icon {
        width: 25px;
        height: 25px;
        margin-bottom: 4px;
        display: block;
        margin-left: auto;
        margin-right: auto;
        transition: filter 0.3s ease;
        -webkit-user-drag: none;
        user-drag: none;
    }

    .tab-btn {
        position: relative;
        background: transparent;
        overflow: hidden;
        border: none;
        padding: 10px 0;
        font-weight: bold;
        color: #656b76; /* Inactive text color updated */
        border-radius: 10px;
        font-size: 14px;
        flex: 1;
        margin: 0 5px;
        cursor: pointer;
        transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .tab-btn::before {
        display: none;
    }

    .tab-btn.active {
        transform: scale(1.08);
        color: #e4e5e7; /* Active text color updated */
        background: none;
        background-clip: initial;
        -webkit-background-clip: initial;
        -webkit-text-fill-color: initial;
        text-fill-color: initial;
    }

    /* Active icon */
    .tab-btn.active .tab-icon {
        filter: brightness(0) saturate(100%) invert(88%) sepia(2%) saturate(167%) hue-rotate(187deg) brightness(98%) contrast(95%);
    }

    /* Inactive icon */
    .tab-btn:not(.active) .tab-icon {
        filter: brightness(0) saturate(100%) invert(38%) sepia(8%) saturate(377%) hue-rotate(186deg) brightness(92%) contrast(85%);
        transition: filter 0.3s ease;
    }


    /* ===== TAB CONTENT PANELS ===== */
    #tabContent {
        flex: 1 1 auto;
        overflow: hidden;
        position: relative;
    }

    .tab-panel {
        position: absolute;
        top: 0;
        left: 0; 
        right: 0; 
        bottom: 0;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        transition: transform 0.4s ease, opacity 0.4s ease;
        opacity: 0;
        pointer-events: none;
        z-index: 0;
        padding-bottom: calc(100px + 20px + env(safe-area-inset-bottom)); /* iOS Safe Area */
    }

    .tab-panel.active {
        transform: translateX(0);
        opacity: 1;
        pointer-events: auto;
        z-index: 10;
    }

    .tab-panel.slide-in-left { transform: translateX(0); opacity: 1; }
    .tab-panel.slide-in-right { transform: translateX(0); opacity: 1; }
    .tab-panel.slide-out-left { transform: translateX(-100%); opacity: 0; }
    .tab-panel.slide-out-right { transform: translateX(100%); opacity: 0; }

    /* ===== COMMON ELEMENTS ===== */
    .image-container { width: 100%; }
    .icon { width: 32px; height: 32px; margin: 0px; }
    .icon-charging { width: 14px; height: 14px; margin: 0px; }
    .icon-large {
        min-width: 50px; min-height: 50px; width: 100%; height: auto;
        max-width: 70px; max-height: 70px; display: block; margin: 0 auto;
    }

    /* ===== CHARGER STATUS ===== */
    #chargerStatusContainer {
        background: #FFF; padding: 20px; box-sizing: border-box; color: #eee;
        flex-grow: 1; flex-shrink: 0; max-width: 1200px; display: flex;
        flex-direction: column; gap: 15px; margin: 10px auto; overflow: hidden;
    }
    .charger-status-item { padding: 12px; border-radius: 12px; display: flex; flex-direction: column; gap: 5px; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); background: #FFFFF; transition: background 0.3s ease, border 0.3s ease; }
    .charger-status-item strong { font-size: 1.1em; color: #1e2128; }
    .charger-status-item .status-text { font-size: 0.95em; color: #1e2128; font-weight: 500; }
    .charger-status-item.vacant { background: #E5E7EB; color: #2D3748; border: 1px solid #E5E7EB; }
    .charger-status-item.occupied { background: #ebe8e3; color: #2D3748; border: 1px solid #ebe8e3; }
    .charger-status-item.upcoming { background: #E5E7EB; color: #2D3748; border: 1px solid #E5E7EB; }
    .charger-status-item .time-left { font-size: 0.90em; font-weight: 600; color: #2D3748; background: rgba(255,255,255,0.3); padding: 4px 8px; border-radius: 6px; display: inline-block; }
    .progress-bar-container { background-color: #e0e0e0; border-radius: 12px; overflow: hidden; height: 12px; width: 100%; margin-top: 8px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
    .progress-bar { height: 100%; width: 0%; transition: width 1s linear; }
    .progress-bar.active { background: linear-gradient(45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 222, 222, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent); background-size: 40px 40px; background-color: rgba(255, 165, 0, 0.6); animation: moveStripes 1s linear infinite; }
    .progress-bar.green.active { background: linear-gradient(45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 222, 222, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent); background-size: 40px 40px; background-color: rgba(0, 200, 0, 0.6); animation: moveStripes 1s linear infinite; }
    @keyframes moveStripes { from { background-position: 0 0; } to { background-position: 40px 0; } }
    .upcoming-session { background: #FFF; border-radius: 8px; padding: 10px; margin-top: 8px; border-left: 3px solid #faa756; line-height: 1.3; }
    .upcoming-session strong { font-size: 1em; color: #1e2128; }
    .upcoming-session .status-text { font-size: 0.9em; color: #1e2128; }
    .upcoming-session .starts-in { font-size: 0.85em; color: #1e2128; font-style: italic; font-weight: bold; }

    /* ===== MODAL STYLES ===== */
    #eventModal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); align-items: center; justify-content: center; }
    #eventModal>div { background: #111827; color: #e4e5e7; padding: 20px; border-radius: 10px; max-width: 400px; width: 90%; box-sizing: border-box; box-shadow: 0 0 10px #111827; font-family: 'Poppins', Arial, sans-serif; position: relative; }
    #closeModal { position: absolute; top: 10px; right: 10px; background: transparent; border: none; font-size: 20px; color: #c7e7f0; cursor: pointer; }
    #modalTitle { margin-top: 0; color: #FFFF; }
    #modalContent { white-space: pre-wrap; font-size: 14px; font-family: 'Poppins', Arial, sans-serif; margin-top: 10px; }

    /* ===== CALENDAR SYSTEM ===== */
    .calendarfilter-container, .calendar-container { width: 100%; max-width: 1200px; margin: 0 auto; box-sizing: border-box; overflow: hidden; flex-shrink: 0; position: relative; }
    .calendar-container { padding-top: 100px; }
    #calendar { width: 100%; max-width: 100%; height: auto; background: #fff; color: #111827; border-radius: 10px; border-color: #F7FAFC; padding: 10px; box-sizing: border-box; min-height: 520px; position: relative; z-index: 1; box-shadow: 0 0 10px #F7FAFC; touch-action: pan-y; }
    .fc-day-today { background: #e4e5e7 !important; border: none !important; } 
    #calendar .fc-view-harness, #calendar .fc-scroller, #calendar .fc-timegrid-body { touch-action: pan-y !important; }
    .fc-event, input, textarea, select, button { touch-action: manipulation; }
    #calendar .fc { touch-action: pan-y; }
    .fc-scroller, .fc-event, .fc-daygrid-event { pointer-events: auto !important; }

    /* ===== FILTER CONTROLS ===== */
    .filter-controls { margin: 15px 0 30px 0; width: 100%; max-width: 1200px; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, auto); gap: 8px 12px; justify-items: center; }
    .filter-btn { padding: 7px 10px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; color: #2D3748; font-size: 14px; width: 100%; max-width: 150px; box-sizing: border-box; user-select: none; background-color: #F7FAFC; transition: background-color 0.3s ease, box-shadow 0.3s ease, outline 0.3s ease, transform 0.2s ease; }
    .filter-btn.active { box-shadow: 0 0 0 2px #545454, 0 0 0 4px #fff; transform: translateY(-2px); }
    .filter-btn-all { background-color: #E5E7EB; }
    .filter-btn-a { background-color: #3B82F6; color: #FFFFFF; }
    .filter-btn-b { background-color: #10B981; color: #FFFFFF; }
    .filter-btn-N1 { background-color: #b11879; color: #FFFFFF; }
    .filter-btn-N2 { background-color: #ff3032; color: #FFFFFF; }
    .filter-btn-club { background-color: #F59E0B; color: #FFFFFF; }

    /* ===== BOOKING FORM ===== */
    .form-and-status-wrapper { display: flex; flex-wrap: wrap; justify-content: center; align-items: flex-start; width: 100%; max-width: 1200px; margin: 20px auto; }
    #bookingForm { width: 100%; max-width: 1200px; flex-grow: 1; flex-shrink: 0; background: #FFFFF; padding: 20px; border-radius: 10px; box-sizing: border-box; color: #545454; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); overflow: hidden; margin: 0 auto; }
    #bookingForm input, #bookingForm select, #bookingForm button { padding: 10px; margin: 8px 0; width: 100%; border-radius: 10px; border: none; box-sizing: border-box; font-size: 15px; }
    #bookingForm input, #bookingForm select { font-family: 'Poppins', Arial, sans-serif; background: #e8e9eb; color: #545454; }
    #bookingForm input::placeholder { color: #aaa; }
    #chargerButtons { margin: 0 auto; display: flex; flex-direction: column; gap: 8px; padding: 0 5px; }
    .row { display: flex; gap: 8px; }
    .row-top, .row-bottom { justify-content: center; }
    .charger-btn { display: inline-flex; justify-content: center; align-items: center; text-align: center; padding: 10px 16px; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; font-size: 14px; user-select: none; transition: all 0.3s ease; }
    .charger-btn:hover { box-shadow: 0 0 0 2px #545454, 0 0 0 4px #fff; }
    .charger-btn.selected { outline: 3px solid #000000; box-shadow: 0 0 0 2px #545454, 0 0 0 4px #fff; transform: translateY(-2px); }
    .save-info-label { display: flex !important; align-items: center; justify-content: center; margin: 10px auto; width: fit-content; gap: 4px; }
    .save-info-label input[type="checkbox"] { margin: 0 !important; width: auto !important; height: 14px; flex-shrink: 0; }
    .save-info-label span { white-space: nowrap; }
    #bookingForm button { background: #656b76; color: #e4e5e7; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease; }
    #bookingForm button:hover:not(:disabled) { background: #111827; }
    #bookingForm button:disabled { opacity: 0.6; cursor: not-allowed; }
    .error, .success { padding: 10px; border-radius: 10px; margin: 10px 0; display: none; font-weight: bold; text-align: center; }
    .error { background: #ff3333; color: white; }
    .success { background: #00cc66; color: white; }

    /* ===== SIDE BUTTONS ===== */
    #sideButtonsWrapper { display: flex; align-items: flex-end; gap: 8px; position: fixed; bottom: calc(80px + env(safe-area-inset-bottom)); right: 20px; z-index: 1000; font-family: Arial, sans-serif; flex-direction: column; }
    #sideButtonsExpandedGroup { display: flex; flex-direction: column; gap: 8px; transition: all 0.3s ease-out; opacity: 0; transform: translateY(50px); pointer-events: none; max-height: 0; overflow: hidden; align-items: flex-end; }
    #sideButtonsExpandedGroup.show-expanded { opacity: 1; transform: translateY(0); pointer-events: auto; max-height: 500px; overflow: visible; }
    .side-button-group { position: relative; }
    .side-btn { background-color: white; opacity: 1; border: none; color: white; font-size: 16px; padding: 1px 1px; border-radius: 8px; cursor: pointer; user-select: none; transition: background-color 0.5s ease; min-width: 44px; min-height: 44px; display: flex; justify-content: center; align-items: center; }
    @keyframes rotate360 { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .side-btn:hover, .side-btn:focus { background-color: #ededed; opacity: 1; outline: none; animation: rotate360 0.6s ease; }
    .side-panel { display: none; position: absolute; bottom: 50px; right: 0; width: 320px; max-width: 90vw; background: white; border: 1px solid #ccc; border-radius: 8px; padding: 15px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); font-size: 14px; color: #333; z-index: 1001; max-height: 400px; overflow-y: auto; }
    .side-panel.show { display: block; }
    form#feedbackForm fieldset { border: 1px solid #ddd; margin-bottom: 12px; padding: 10px; border-radius: 6px; }
    form#feedbackForm legend { font-weight: bold; padding: 0 6px; }
    form#feedbackForm textarea { width: 100%; resize: vertical; font-family: inherit; font-size: 14px; padding: 6px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
    form#feedbackForm label { cursor: pointer; margin-right: 10px; }
    #feedbackSubmitBtn { width: 100%; margin-top: 10px; background: #111827; color: #e4e5e7; cursor: pointer; transition: background-color 0.3s ease; }
    #feedbackMessage { margin-top: 10px; min-height: 18px; font-weight: 600; }
    #helpPanel a { color: #18db80; text-decoration: underline; transition: color 0.2s ease; }
    #helpPanel a:hover { color: #06806b; text-decoration: none; }
    
    /* ===== PWA UPDATE & FIREBASE NOTIFICATIONS (from original github.io file) ===== */
    #update-notification { display: none; position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100%); background: #fffbe6; border: 1px solid #ffecb3; padding: 16px 20px; text-align: center; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1000; animation: slideIn 0.4s forwards; transition: transform 0.4s ease, opacity 0.4s ease; }
    #update-notification p { margin: 0; font-size: 14px; color: #333; }
    #update-notification button { margin-top: 10px; padding: 8px 16px; background-color: #378fee; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; }
    .dismiss-notification { transform: translateX(-50%) translateY(50px); opacity: 0; }
    @keyframes slideIn { to { transform: translateX(-50%) translateY(0%); } }
    @keyframes smoothSlideOut { to { transform: translateX(-50%) translateY(50px); opacity: 0; } }
    #updateToast { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: #fff; padding: 14px 24px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 1000; font-family: sans-serif; text-align: center; max-width: 90vw; box-sizing: border-box; }
    #updateToast div { margin-bottom: 8px; white-space: nowrap; }
    #refreshBtn { padding: 6px 12px; background-color: #4CAF50; border: none; color: white; border-radius: 4px; cursor: pointer; }

    /* MEDIA QUERIES (from styles.txt, UNCHANGED) */
    @media (max-width: 768px) {
      body { min-height: 100%; height: auto; overflow-x: hidden; overflow-y: auto; padding: 10px; font-size: 14px; -webkit-overflow-scrolling: touch; }
      .tab-icon { width: 20px; height: 20px; }
      .tab-btn { padding: 5px 0px; font-size: 10px; }
      #tabContent { width: 100%; max-width: 1200px; margin-bottom: 20px; }
      .icon-large { width: 35px; height: 35px; max-width: 35px; max-height: 35px; }
      .icon-charging { width: 12px; height: 12px; }
      h1 { font-size: 1.3em; margin-bottom: 15px; line-height: 1.3; }
      #calendar { padding: 8px; }
      .fc .fc-toolbar { flex-direction: row; gap: 3px; }
      .fc .fc-toolbar .fc-button-group { display: flex; justify-content: center; }
      .fc .fc-toolbar .fc-button { font-size: 10px; padding: 1px 1px; margin: 0 1px; }
      .fc .fc-toolbar-title { font-size: 12px; text-align: center; margin: 1px 0; }
      .fc .fc-day-today { background: #e4e5e7 !important; border: none !important; } 
      .fc-timeGridWeek-view .fc-col-header { position: sticky; top: 0; background: #ffffff; z-index: 5; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      .fc-timegrid-body { overflow-y: auto; }
      .fc .fc-timegrid-slot { height: 10px !important; min-height: 10px !important; padding: 0 !important; }
      .fc .fc-col-header-cell-cushion { font-size: 9px !important; }
      .fc .fc-timegrid-slot-label { font-size: 9px !important; padding: 0 4px !important; height: 10px !important; line-height: 10px !important; }
      .fc .fc-event { font-size: 9px; padding: 2px; white-space: normal !important; overflow-wrap: break-word; word-break: break-word; height: auto !important; min-height: 20px; }
      .fc .fc-event-main { display: block !important; width: 100% !important; }
      .fc .fc-event-title, .fc .fc-event-title-container { font-size: 9px; display: block !important; width: 100% !important; overflow-wrap: break-word; word-break: break-word; white-space: normal !important; }
      .fc-timegrid-event .fc-event-main { white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; display: block !important; }
      .fc .fc-daygrid-day-number { font-size: 12px; padding: 4px; }
      .fc .fc-daygrid-event { font-size: 12px; margin-bottom: 1px; }
      .filter-controls { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, auto); gap: 6px; width: 100%; padding: 0 2px; box-sizing: border-box; }
      .filter-btn { padding: 6px 8px; font-size: 12px; border-radius: 8px; width: 100%; box-sizing: border-box; }
      .form-and-status-wrapper { width: 100%; max-width: 100%; box-sizing: border-box; padding: 0; }
      #bookingForm { width: 100%; max-width: 100%; padding: 15px; border-radius: 8px; overflow-x: hidden; }
      #bookingForm input, #bookingForm select, #bookingForm button { font-size: 12px; padding: 12px; margin: 6px 0; border-radius: 8px; }
      #chargerButtons { max-width: 768px; margin: 0 auto; display: flex; flex-direction: column; gap: 8px; padding: 0 5px; }
      .row { display: flex; gap: 8px; }
      .row-top, .row-bottom { justify-content: center; }
      .charger-btn { width: 100px; flex: 0 0 100px; padding: 10px; font-size: 12px; border-radius: 8px; }
      #chargerStatusContainer { padding: 15px; max-width: none; gap: 12px; }
      .charger-status-item { padding: 10px; gap: 6px; }
      .charger-status-item strong { font-size: 1em; }
      .charger-status-item .status-text { font-size: 0.9em; }
      .upcoming-session { padding: 8px; margin-top: 6px; }
      .upcoming-session strong { font-size: 0.9em; }
      .upcoming-session .status-text { font-size: 0.85em; line-height: 1.2; }
      .upcoming-session .starts-in { font-size: 0.85em; }
      #eventModal>div { margin: 10px; padding: 15px; max-width: none; width: calc(100% - 20px); border-radius: 8px; }
      #modalTitle { font-size: 1.1em; padding-right: 30px; }
      #modalContent { font-size: 13px; line-height: 1.4; }
      #closeModal { font-size: 18px; padding: 5px; }
    }
    @media (max-width: 480px) {
      body { padding: 8px; }
      h1 { font-size: 1.2em; margin-bottom: 12px; }
      #calendar { padding: 5px; }
      .fc .fc-toolbar { flex-wrap: nowrap; flex-direction: row; align-items: center; justify-content: space-between; gap: 1px; }
      .fc .fc-toolbar .fc-button-group { display: flex; flex-direction: row; flex-wrap: nowrap; gap: 0px; }
      .fc .fc-toolbar .fc-button { font-size: 10px; padding: 1px 2px; margin: 0; min-width: auto; white-space: nowrap; }
      .fc .fc-toolbar-title { font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; margin: 0 4px; flex: 1; text-align: center; }
      .filter-controls { grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, auto); gap: 6px; padding: 0 5px; }
      .filter-btn { padding: 6px; font-size: 11px; max-width: none; }
      #bookingForm { padding: 12px; }
      #bookingForm input, #bookingForm select, #bookingForm button { font-size: 11px; padding: 10px; }
      #sideButtonsWrapper { bottom: calc(80px + env(safe-area-inset-bottom)); right: 10px; gap: 6px; }
      .side-btn { font-size: 14px; min-width: 36px; min-height: 36px; border-radius: 8px; }
      .side-panel { bottom: 60px; left: 45%; transform: translateX(-100%); width: calc(80vw - 50px); max-height: 350px; font-size: 12px; }
      #eventModal>div { margin: 5px; padding: 12px; width: calc(100% - 10px); }
    }
  </style>
</head>
<body>
  
  <!-- The main app UI now lives here, NOT in an iframe -->
  <div id="appHeader">
    <div style="display: flex; align-items: center; gap: 30px;">
      <div class="image-container">
        <img class="icon icon-large" src="https://github.com/emeraldevbooking/emeraldevbooking.github.io/blob/main/assets/images/favicons/android-chrome-192x192.png?raw=true" alt="Main Icon">
      </div>
      <h1 style="margin: 0; white-space: nowrap;">
        Emerald Hills<br>
         <span style="font-weight: 280;">EV Charger Reservation</span>
      </h1>
    </div>
  </div>

  <div id="mainAppWrapper">
    <!-- Tab Panels -->
    <div id="tabContent">
      <!-- Status Panel -->
      <div id="statusPanel" class="tab-panel active">
          <div id="chargerStatusContainer">
            <div id="statusTowerA" class="charger-status-item"></div>
            <div id="statusTowerB" class="charger-status-item"></div>
            <div id="statusNorth1" class="charger-status-item"></div>
            <div id="statusNorth2" class="charger-status-item"></div>
            <div id="statusClubhouse" class="charger-status-item"></div>
          </div>
      </div>
      <!-- Calendar Panel -->
      <div id="calendarPanel" class="tab-panel">
        <div class="calendarfilter-container">
          <div class="filter-controls" role="group" aria-label="Filter chargers">
              <button class="filter-btn filter-btn-all active" data-charger="all" type="button" aria-pressed="true">All</button>
              <button class="filter-btn filter-btn-a" data-charger="Tower A" type="button" aria-pressed="false">Tower A</button>
              <button class="filter-btn filter-btn-b" data-charger="Tower B" type="button" aria-pressed="false">Tower B</button>
              <button class="filter-btn filter-btn-club" data-charger="Clubhouse" type="button" aria-pressed="false">Clubhouse</button>
              <button class="filter-btn filter-btn-N1" data-charger="North 1" type="button" aria-pressed="false">North 1</button>
              <button class="filter-btn filter-btn-N2" data-charger="North 2" type="button" aria-pressed="false">North 2</button>
          </div>
          <div class="calendar-container">
            <div id="calendar"></div>
          </div>
        </div>
      </div>
      <!-- Booking Form Panel -->
      <div id="formPanel" class="tab-panel">
        <div class="form-and-status-wrapper">
          <form id="bookingForm" method="POST" autocomplete="on" novalidate>
            <div id="errorMsg" class="error" role="alert"></div>
            <div id="successMsg" class="success" role="status"></div>
            <input id="name" name="name" type="text" autocomplete="name" placeholder="Name of Car Owner" required oninput="convertToTitleCase(this)" />
            <input id="plate" name="license_plate" type="text" autocomplete="nickname" placeholder="Car Plate Number" required oninput="this.value = this.value.toUpperCase()" />
            <input id="phone" name="tel" type="tel" autocomplete="tel" placeholder="Phone Number" pattern="[0-9]*" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '');" />
            <input id="email" name="email" type="email" autocomplete="email" placeholder="Email for Confirmation (Required)" required />
            <div id="chargerButtons">
              <div class="row row-top">
                <button type="button" class="charger-btn filter-btn-a" data-charger="Tower A">Tower A</button>
                <button type="button" class="charger-btn filter-btn-b" data-charger="Tower B">Tower B</button>
                <button type="button" class="charger-btn filter-btn-club" data-charger="Clubhouse">Clubhouse</button>
              </div>
              <div class="row row-bottom">
                <button type="button" class="charger-btn filter-btn-N1" data-charger="North 1">North 1</button>
                <button type="button" class="charger-btn filter-btn-N2" data-charger="North 2">North 2</button>
              </div>
            </div>
            <input type="hidden" id="charger" name="charger" required/>
            <label for="start_datetime">Start Date & Time</label>
            <input id="start_datetime" name="start_datetime" type="datetime-local" step="1800" required />
            <label for="end_datetime">End Date & Time</label>
            <input id="end_datetime" name="end_datetime" type="datetime-local" step="1800" required />
            <label class="save-info-label"><input type="checkbox" id="rememberMe" />Autofill details</label>
            <button type="submit">Reserve</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Buttons -->
  <div id="tabButtons">
    <button class="tab-btn active" onclick="showTab('status')"><img src="https://cdn-icons-png.flaticon.com/128/10024/10024154.png" class="tab-icon"><span>Status</span></button>
    <button class="tab-btn" onclick="showTab('calendar')"><img src="https://cdn-icons-png.flaticon.com/128/18349/18349398.png" class="tab-icon"><span>Calendar</span></button>
    <button class="tab-btn" onclick="showTab('form')"><img src="https://cdn-icons-png.flaticon.com/128/16491/16491307.png" class="tab-icon"><span>Reserve</span></button>
  </div>

  <!-- Side Buttons and Panels -->
  <div id="sideButtonsWrapper">
      <div id="sideButtonsExpandedGroup">
          <div class="side-button-group">
              <button id="helpBtn" class="side-btn"><img class="icon" src="https://cdn-icons-gif.flaticon.com/11688/11688376.gif" alt="Help"></button>
              <div id="helpPanel" class="side-panel">
                  <strong>Reservation Cancellation</strong><br>Use the link in your confirmation email to cancel.<br><br>
                  <strong>Issues? Contact us on WhatsApp:</strong><br>
                  Ken - <a href="https://wa.link/2j8nrw" target="_blank">Chat</a> | Max - <a href="https://wa.link/soelvy" target="_blank">Chat</a><br><br>
                  <strong>Community Group:</strong><br>
                  <a href="https://chat.whatsapp.com/Ja1eSJSGug20nj1Wqk3OtP" target="_blank">Join Emerald Hills EV Owners</a><br><br>
                  Â© <span id="copyrightYear"></span>. v2.0
              </div>
          </div>
          <div class="side-button-group">
              <button id="faqBtn" class="side-btn"><img class="icon" src="https://cdn-icons-gif.flaticon.com/12205/12205155.gif" alt="FAQ"></button>
              <div id="faqPanel" class="side-panel"><strong>FAQ</strong><br><br><strong>Q: Who made this?</strong><br>A community-driven app by Emerald Hills EV owners to streamline charger scheduling.<br><br><strong>Q: Is this official?</strong><br>No, this app is independent and not affiliated with Emerald Hills Management.<br><br><strong>Q: How do I modify a booking?</strong><br>Please cancel your old booking via the email link and create a new one.</div>
          </div>
          <div class="side-button-group">
              <button id="feedbackBtn" class="side-btn"><img class="icon" src="https://cdn-icons-gif.flaticon.com/15370/15370746.gif" alt="Feedback"></button>
              <div id="feedbackPanel" class="side-panel">
                  <form id="feedbackForm" novalidate>
                      <fieldset><legend>Bug Reporting</legend><label><input type="radio" name="bugEncountered" value="Yes" required> Yes</label> <label><input type="radio" name="bugEncountered" value="No" required> No</label><br><textarea name="bugDetails" placeholder="Please describe the bug" rows="3"></textarea></fieldset>
                      <fieldset><legend>Suggestions</legend><textarea name="suggestions" placeholder="What features would you like to see?" rows="3"></textarea></fieldset>
                      <button type="submit" id="feedbackSubmitBtn" class="side-btn">Submit</button>
                      <div id="feedbackMessage"></div>
                  </form>
              </div>
          </div>
      </div>
      <button id="moreBtn" class="side-btn"><img class="icon" src="https://cdn-icons-gif.flaticon.com/16046/16046406.gif" alt="More Options"></button>
  </div>
  
  <!-- Event Modal -->
  <div id="eventModal"><div id="modalInner"><button id="closeModal">&times;</button><h2 id="modalTitle"></h2><pre id="modalContent"></pre></div></div>
  
  <!-- PWA & Firebase Notifications -->
  <div id="update-notification"><p>ðŸ”” A new reservation has been added.</p><button onclick="refreshPage()">Update Now</button></div>
  <div id="updateToast"><div>ðŸ”„ New version available</div><button id="refreshBtn">Update Now</button></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- THE ALL-IN-ONE JAVASCRIPT LOGIC -->
  <script>
    /****************************************************************
     *                  CRITICAL CONFIGURATION                      *
     *   PASTE THE WEB APP URL YOU COPIED FROM STEP 2 BELOW         *
     ****************************************************************/
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzgLMpLsD26Nilh9NPf7QiDVjscIcpHPh1REfZVKWVnpXVpK488prqJsRF0NKN4FdtI/exec'; // <-- PASTE YOUR URL HERE!


    /* =================================================================
       CORE APP LOGIC (refactored from script.txt)
       ================================================================= */
    let currentIndex = 0;
    const tabPanels = ['status', 'calendar', 'form'];
    let calendar = null;
    let allEvents = [];
    
    // The google.script.run calls have been replaced with fetch() calls
    // to your new Web App URL. This is the key to the new architecture.

    // Example of the change:
    // OLD: google.script.run.withSuccessHandler(...).getBookings();
    // NEW: fetch(`${WEB_APP_URL}?action=getBookings`).then(...)

    function showTab(tab) {
        const panels = { status: document.getElementById('statusPanel'), calendar: document.getElementById('calendarPanel'), form: document.getElementById('formPanel') };
        const newIndex = tabPanels.indexOf(tab);
        if (newIndex === currentIndex) return;
        
        const direction = (newIndex < currentIndex) ? 'right' : 'left';
        Object.values(panels).forEach(p => p.classList.remove('slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right'));
        
        const currentPanel = panels[tabPanels[currentIndex]];
        const nextPanel = panels[tabPanels[newIndex]];
        
        currentPanel.classList.remove('active');
        currentPanel.classList.add(direction === 'left' ? 'slide-out-left' : 'slide-out-right');
        nextPanel.classList.add('active');
        nextPanel.classList.add(direction === 'left' ? 'slide-in-left' : 'slide-in-right');

        setTimeout(() => {
            currentPanel.classList.remove('slide-out-left', 'slide-out-right');
            nextPanel.classList.remove('slide-in-left', 'slide-in-right');
        }, 400);

        document.querySelectorAll('#tabButtons .tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.tab-btn[onclick*="showTab('${tab}')"]`)?.classList.add('active');
        currentIndex = newIndex;
        if (tab === 'calendar' && calendar) setTimeout(() => calendar.render(), 0);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Hammer.js swipe navigation
        const hammerManager = new Hammer(document.getElementById('mainAppWrapper'));
        hammerManager.add(new Hammer.Swipe({ direction: Hammer.DIRECTION_HORIZONTAL }));
        hammerManager.on('swipeleft', e => !e.target.closest('#calendar') && showTabByIndex(currentIndex + 1));
        hammerManager.on('swiperight', e => !e.target.closest('#calendar') && showTabByIndex(currentIndex - 1));
        function showTabByIndex(index) {
            if (index < 0 || index >= tabPanels.length) return;
            showTab(tabPanels[index]);
        }

        // Side buttons logic (unchanged)
        const buttons = [{ btnId: 'helpBtn', panelId: 'helpPanel' }, { btnId: 'faqBtn', panelId: 'faqPanel' }, { btnId: 'feedbackBtn', panelId: 'feedbackPanel' }];
        const moreBtn = document.getElementById('moreBtn');
        const expandedGroup = document.getElementById('sideButtonsExpandedGroup');
        let openPanel = null;
        function closeAllIndividualPanels() {
            buttons.forEach(({ btnId, panelId }) => {
                document.getElementById(btnId).setAttribute('aria-expanded', 'false');
                const panel = document.getElementById(panelId);
                panel.classList.remove('show');
                panel.setAttribute('aria-hidden', 'true');
            });
            openPanel = null;
        }
        buttons.forEach(({ btnId, panelId }) => {
            const button = document.getElementById(btnId);
            const panel = document.getElementById(panelId);
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const isExpanded = button.getAttribute('aria-expanded') === 'true';
                buttons.forEach(b => { if (b.btnId !== btnId) { document.getElementById(b.btnId).setAttribute('aria-expanded', 'false'); document.getElementById(b.panelId).classList.remove('show'); } });
                if (!isExpanded) { button.setAttribute('aria-expanded', 'true'); panel.classList.add('show'); panel.setAttribute('aria-hidden', 'false'); panel.focus(); openPanel = panel; } else { closeAllIndividualPanels(); }
            });
        });
        moreBtn.addEventListener('click', (e) => { e.stopPropagation(); const isExpanded = moreBtn.getAttribute('aria-expanded') === 'true'; if (!isExpanded) { expandedGroup.classList.add('show-expanded'); moreBtn.setAttribute('aria-expanded', 'true'); } else { expandedGroup.classList.remove('show-expanded'); moreBtn.setAttribute('aria-expanded', 'false'); closeAllIndividualPanels(); } });
        document.addEventListener('mousedown', (e) => { if (expandedGroup.classList.contains('show-expanded') && !expandedGroup.contains(e.target) && !moreBtn.contains(e.target)) { expandedGroup.classList.remove('show-expanded'); moreBtn.setAttribute('aria-expanded', 'false'); closeAllIndividualPanels(); } else if (openPanel && !openPanel.contains(e.target) && !buttons.some(({ btnId }) => document.getElementById(btnId).contains(e.target))) { closeAllIndividualPanels(); } });
        document.getElementById('copyrightYear').textContent = new Date().getFullYear();

        // Feedback form submission - REFACTORED to use fetch()
        document.getElementById('feedbackForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const feedbackMessage = document.getElementById('feedbackMessage');
            const bugEncountered = e.target.bugEncountered.value;
            if (!bugEncountered) { feedbackMessage.style.color = 'red'; feedbackMessage.textContent = 'Please select Yes or No.'; return; }
            const formData = { bugEncountered: bugEncountered, bugDetails: e.target.bugDetails.value.trim(), suggestions: e.target.suggestions.value.trim() };
            e.target.querySelector('button[type="submit"]').disabled = true;
            feedbackMessage.style.color = 'black';
            feedbackMessage.textContent = 'Submitting...';

            fetch(WEB_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'submitFeedback', data: formData })
            })
            .then(response => response.json())
            .then(response => {
                if (response.status === 'success') {
                    feedbackMessage.style.color = 'green';
                    feedbackMessage.textContent = 'Thank you for your feedback!';
                    e.target.reset();
                } else { throw new Error(response.message || 'Unknown error'); }
            })
            .catch(err => {
                feedbackMessage.style.color = 'red';
                feedbackMessage.textContent = 'Error: ' + err.message;
            })
            .finally(() => {
                e.target.querySelector('button[type="submit"]').disabled = false;
            });
        });

        // Charger button and form logic (unchanged)
        const chargerButtons = document.querySelectorAll('.charger-btn');
        const chargerInput = document.getElementById('charger');
        chargerButtons.forEach(btn => btn.addEventListener('click', function() { chargerButtons.forEach(b => b.classList.remove('selected')); this.classList.add('selected'); chargerInput.value = this.getAttribute('data-charger'); }));
        document.getElementById('bookingForm').addEventListener('submit', function(e) { if (!chargerInput.value) { e.preventDefault(); showMessage('error', 'Please select a charger location.'); } });
        
        // Load user info from IndexedDB (unchanged, but now works reliably!)
        populateFormWithStoredUserInfo();

        // Initial setup
        const now = new Date();
        const ms = 1000 * 60 * 30;
        const roundedNow = new Date(Math.ceil(now.getTime() / ms) * ms);
        document.getElementById('start_datetime').value = toDatetimeLocal(roundedNow, 'Asia/Kuala_Lumpur');
        const plusOneHour = new Date(roundedNow.getTime() + 60 * 60 * 1000);
        document.getElementById('end_datetime').value = toDatetimeLocal(plusOneHour, 'Asia/Kuala_Lumpur');
        loadBookings();
        setupFilterButtons();
        setInterval(updateChargerStatus, 30 * 1000);
    });

    function showMessage(type, message) {
        const errorDiv = document.getElementById('errorMsg');
        const successDiv = document.getElementById('successMsg');
        const div = type === 'error' ? errorDiv : successDiv;
        const otherDiv = type === 'error' ? successDiv : errorDiv;
        div.textContent = message;
        div.style.display = 'block';
        otherDiv.style.display = 'none';
        setTimeout(() => div.style.display = 'none', 7000);
    }

    function showEventDetails(event) {
        const modal = document.getElementById('eventModal');
        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'Asia/Kuala_Lumpur' };
        document.getElementById('modalTitle').textContent = event.title;
        document.getElementById('modalContent').textContent = `Charger: ${event.extendedProps.charger}\nStart: ${new Date(event.start).toLocaleString('en-US', options)}\nEnd: ${new Date(event.end).toLocaleString('en-US', options)}\nCar Plate: ${event.extendedProps.plate}`;
        modal.style.display = 'flex';
    }
    document.getElementById('closeModal').addEventListener('click', () => document.getElementById('eventModal').style.display = 'none');
    document.getElementById('eventModal').addEventListener('click', e => { if (e.target.id === 'eventModal') document.getElementById('eventModal').style.display = 'none'; });

    function convertToTitleCase(input) { input.value = input.value.toLowerCase().replace(/\b\w/g, char => char.toUpperCase()); }

    // loadBookings - REFACTORED to use fetch()
    async function loadBookings() {
        console.groupCollapsed(`[Booking Loader] Starting update @ ${new Date().toLocaleTimeString()}`);
        let cachedEvents = [];
        try {
            console.log('Step 1: Loading from IndexedDB...');
            cachedEvents = await loadEventsFromIDB();
            if (cachedEvents && cachedEvents.length > 0) {
                console.info(`%cSuccess: Loaded ${cachedEvents.length} events from cache.`, 'color: green;');
                allEvents = cachedEvents;
                renderCalendar(allEvents);
                updateChargerStatus();
            } else { console.warn('No cached events found.'); }
        } catch (err) {
            console.error('Error loading from IndexedDB:', err);
            showMessage('error', 'Error loading cached bookings.');
            console.groupEnd(); return;
        }

        console.log('Step 2: Fetching from server...');
          fetch(WEB_APP_URL, {
	      method: 'POST',
	      headers: { 'Content-Type': 'application/json' },
	      body: JSON.stringify({ action: 'getBookings' })
            .then(response => response.json())
            .then(async serverResponse => {
                console.group('[Server Response]');
                if (serverResponse.status !== 'success') throw new Error(serverResponse.message);
                const eventsFromServer = serverResponse.data;
                console.info(`Success: Received ${eventsFromServer.length} events.`);

                const serverIds = eventsFromServer.map(e => e.id).sort().join(',');
                const cachedIds = cachedEvents.map(e => e.id).sort().join(',');

                if (serverIds !== cachedIds) {
                    console.info('%cChange detected. Updating local data.', 'color: blue; font-weight: bold;');
                    allEvents = eventsFromServer;
                    await saveEventsToIDB(eventsFromServer);
                    console.info(`%cSaved ${eventsFromServer.length} new events to IndexedDB.`, 'color: green;');
                    renderCalendar(allEvents);
                    updateChargerStatus();
                } else { console.log('No changes detected.'); }
                console.groupEnd(); console.groupEnd();
            })
            .catch(err => {
                console.error('Server load failed:', err.message || err);
                if (allEvents.length === 0) showMessage('error', 'Could not load calendar: ' + err.message);
                console.groupEnd();
            });
    }

    function renderCalendar(events) {
        const calendarEl = document.getElementById('calendar');
        if (calendar) { calendar.removeAllEvents(); calendar.addEventSource(events); return; }
        const isMobile = window.innerWidth <= 768;
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek', allDaySlot: false, stickyHeaderDates: true, timeZone: 'local', firstDay: 1, nowIndicator: true,
            editable: false, longPressDelay: 9999, selectable: false,
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
            events: events, contentHeight: isMobile ? 'auto' : 'auto', scrollTimeReset: false,
            eventClick: info => showEventDetails(info.event),
            eventContent: arg => ({ html: `<div class="fc-event-main-frame"><div class="fc-event-title-container" style="font-weight:bold;"><div class="fc-event-title fc-sticky" style="color:#FFF;">${arg.event.title}</div><div style="font-size:0.85em; color:#FFF;">${arg.event.extendedProps.charger}</div></div></div>` })
        });
        calendar.render();
        calendarEl.style.touchAction = 'pan-y';
        setTimeout(() => calendarEl.querySelectorAll('.fc-view-harness, .fc-scroller, .fc-timegrid-body').forEach(el => el.style.touchAction = 'pan-y'), 100);
        const calendarHammer = new Hammer(calendarEl, { touchAction: 'pan-y' });
        calendarHammer.on('swipeleft', e => { e.srcEvent.stopPropagation(); calendar.next(); });
        calendarHammer.on('swiperight', e => { e.srcEvent.stopPropagation(); calendar.prev(); });
    }

    function updateChargerStatus() {
        const chargers = { 'Tower A': 'statusTowerA', 'Tower B': 'statusTowerB', 'North 1': 'statusNorth1', 'North 2': 'statusNorth2', 'Clubhouse': 'statusClubhouse' };
        const statusMap = Object.keys(chargers).reduce((acc, name) => ({ ...acc, [name]: { occupied: false, event: null, upcomingEvent: null } }), {});
        const now = new Date();
        allEvents.forEach(event => {
            const charger = event.extendedProps.charger;
            if (!statusMap[charger]) return;
            const start = new Date(event.start); const end = new Date(event.end);
            if (now >= start && now < end) { statusMap[charger].occupied = true; statusMap[charger].event = event; }
            else if (start > now && (!statusMap[charger].upcomingEvent || new Date(statusMap[charger].upcomingEvent.start) > start)) { statusMap[charger].upcomingEvent = event; }
        });
        Object.entries(statusMap).forEach(([chargerName, status]) => {
            const div = document.getElementById(chargers[chargerName]);
            if (!div) return;
            let html = '';
            if (status.occupied) {
                const event = status.event; const start = new Date(event.start); const end = new Date(event.end); const total = end - start; const elapsed = now - start;
                const progress = Math.min(100, (elapsed / total) * 100);
                const remainingMinutes = Math.floor((end - now) / 60000);
                const hoursLeft = Math.floor(remainingMinutes / 60); const minutesLeft = remainingMinutes % 60;
                const timeLeftText = hoursLeft > 0 ? `${hoursLeft}h ${minutesLeft}m left` : `${minutesLeft}m left`;
                html = `<div class="charger-status-item occupied"><div style="display: flex; justify-content: space-between; align-items: center;"><strong>${chargerName}</strong><span style="font-size: 0.80em; font-weight: bold; color: #1e2128;">${timeLeftText}</span></div><span class="status-text"><b>Charging</b><br>${event.title}<br><small>${start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} to ${end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small></span><div class="progress-bar-container"><div class="progress-bar ${progress <= 80 ? 'orange' : 'green'} active" style="width:${progress}%;"></div></div>${generateUpcomingHtml(status.upcomingEvent, now)}</div>`;
            } else {
                html = `<div class="charger-status-item ${status.upcomingEvent ? 'upcoming' : 'vacant'}"><strong>${chargerName}</strong><span class="status-text"><strong>Available</strong></span>${generateUpcomingHtml(status.upcomingEvent, now)}</div>`;
            }
            if (div.innerHTML !== html) div.innerHTML = html;
        });
    }

    function generateUpcomingHtml(event, now) {
        if (!event) return '';
        const start = new Date(event.start);
        const diffMinutes = Math.floor((start - now) / 60000);
        const days = Math.floor(diffMinutes / 1440); const hours = Math.floor((diffMinutes % 1440) / 60); const minutes = diffMinutes % 60;
        let startsIn = days > 0 ? `in ${days}d ${hours}h` : hours > 0 ? `in ${hours}h ${minutes}m` : `in ${minutes}m`;
        return `<div class="upcoming-session"><strong>Upcoming:</strong> ${event.title}<br><small>${start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} (${startsIn})</small></div>`;
    }

    function filterEventsByCharger(charger) {
        if (!calendar) return;
        const filtered = (charger === 'all') ? allEvents : allEvents.filter(e => e.extendedProps.charger === charger);
        calendar.removeAllEvents(); calendar.addEventSource(filtered);
    }
    function setupFilterButtons() {
        const buttons = document.querySelectorAll('.filter-btn');
        buttons.forEach(btn => btn.addEventListener('click', () => { buttons.forEach(b => b.classList.remove('active')); btn.classList.add('active'); filterEventsByCharger(btn.dataset.charger); }));
    }

    // Booking form submission - REFACTORED to use fetch()
    document.getElementById('bookingForm').addEventListener('submit', async function(ev) {
        ev.preventDefault();
        const submitBtn = ev.target.querySelector('button[type="submit"]');
        submitBtn.textContent = 'Processing...'; submitBtn.disabled = true;
        const data = { name: ev.target.name.value.trim(), plate: ev.target.plate.value.trim(), phone: ev.target.phone.value.trim(), email: ev.target.email.value.trim(), charger: ev.target.charger.value, start_datetime: ev.target.start_datetime.value, end_datetime: ev.target.end_datetime.value };
        if (!data.name || !data.plate || !data.email || !data.charger || !data.start_datetime || !data.end_datetime) { showMessage('error', 'Please fill all required fields.'); submitBtn.textContent = 'Reserve'; submitBtn.disabled = false; return; }
        if (new Date(data.end_datetime) <= new Date(data.start_datetime)) { showMessage('error', 'End time must be after start time.'); submitBtn.textContent = 'Reserve'; submitBtn.disabled = false; return; }
        
        const remember = document.getElementById('rememberMe').checked;
        if (remember) { saveUserInfo('name', data.name); saveUserInfo('email', data.email); saveUserInfo('phone', data.phone); saveUserInfo('plate', data.plate); saveUserInfo('rememberMe', true); }
        else { await clearUserInfo(); }

        fetch(WEB_APP_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'book', data: data })
        })
        .then(res => res.json())
        .then(res => {
            if (res.status === 'success') {
                showMessage('success', res.message);
                ev.target.reset();
                const now = new Date(Math.ceil(new Date().getTime() / (1000 * 60 * 30)) * (1000 * 60 * 30));
                document.getElementById('start_datetime').value = toDatetimeLocal(now, 'Asia/Kuala_Lumpur');
                document.getElementById('end_datetime').value = toDatetimeLocal(new Date(now.getTime() + 60*60*1000), 'Asia/Kuala_Lumpur');
                loadBookings();
                const bookingDate = new Date(data.start_datetime);
                calendar.gotoDate(bookingDate);
            } else { throw new Error(res.message); }
        })
        .catch(err => {
            showMessage('error', 'Reservation failed: ' + err.message);
        })
        .finally(() => {
            submitBtn.textContent = 'Reserve'; submitBtn.disabled = false;
        });
    });

    function toDatetimeLocal(dt, tz) {
        const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false, timeZone: tz };
        const parts = new Intl.DateTimeFormat('en-US', options).formatToParts(dt).reduce((acc, part) => ({ ...acc, [part.type]: part.value }), {});
        return `${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}`;
    }
    
    /* =================================================================
       INDEXEDDB CACHING LOGIC (Unchanged, now in the correct context)
       ================================================================= */
    const dbName = 'EVChargerDB'; const dbVersion = 2; let db;
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(dbName, dbVersion);
        request.onupgradeneeded = e => { db = e.target.result; if (!db.objectStoreNames.contains('bookings')) db.createObjectStore('bookings', { keyPath: 'id' }); if (!db.objectStoreNames.contains('userinfo')) db.createObjectStore('userinfo', { keyPath: 'key' }); };
        request.onsuccess = e => { db = e.target.result; resolve(db); };
        request.onerror = e => reject('IndexedDB error: ' + e.target.errorCode);
      });
    }
    async function saveEventsToIDB(events) { const db = await openDB(); const tx = db.transaction('bookings', 'readwrite'); tx.objectStore('bookings').clear(); events.forEach(event => { if (event.id) tx.objectStore('bookings').put(event); }); return tx.complete; }
    async function loadEventsFromIDB() { const db = await openDB(); return db.transaction('bookings', 'readonly').objectStore('bookings').getAll(); }
    async function saveUserInfo(key, value) { const db = await openDB(); return db.transaction('userinfo', 'readwrite').objectStore('userinfo').put({ key, value }); }
    async function loadUserInfo(key) { const db = await openDB(); const request = db.transaction('userinfo', 'readonly').objectStore('userinfo').get(key); return new Promise(resolve => { request.onsuccess = () => resolve(request.result?.value ?? null); }); }
    async function clearUserInfo() { const db = await openDB(); return db.transaction('userinfo', 'readwrite').objectStore('userinfo').clear(); }
    async function populateFormWithStoredUserInfo() { if (await loadUserInfo('rememberMe')) { document.getElementById('rememberMe').checked = true; document.getElementById('name').value = await loadUserInfo('name') || ''; document.getElementById('phone').value = await loadUserInfo('phone') || ''; document.getElementById('email').value = await loadUserInfo('email') || ''; document.getElementById('plate').value = await loadUserInfo('plate') || ''; console.log('Loaded user info from IndexedDB.'); } }


    /* =================================================================
       PWA & FIREBASE LOGIC (from original github.io file)
       ================================================================= */
    if ('serviceWorker' in navigator) {
      let refreshing = false;
      navigator.serviceWorker.register('/service-worker.js').then(reg => {
        reg.addEventListener('updatefound', () => {
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              const toast = document.getElementById('updateToast');
              if (toast) {
                toast.style.display = 'block';
                document.getElementById('refreshBtn').onclick = async () => {
                  try {
                    await Promise.all((await caches.keys()).map(name => caches.delete(name)));
                    refreshing = true;
                    toast.style.display = 'none';
                    newWorker.postMessage({ action: 'skipWaiting' });
                  } catch (error) { console.error('Update error:', error); refreshing = false; }
                };
              }
            }
          });
        });
      }).catch(err => console.error('SW registration failed:', err));
      navigator.serviceWorker.addEventListener('controllerchange', () => { if (refreshing) window.location.reload(); });
    }

    // Firebase for live notifications
    document.addEventListener('DOMContentLoaded', () => {
      const updateBanner = document.getElementById('update-notification');
      const hammer = new Hammer(updateBanner);
      hammer.get('swipe').set({ direction: Hammer.DIRECTION_VERTICAL });
      hammer.on('swipeup swipedown', () => { updateBanner.style.display = 'none'; });
      const firebaseConfig = { apiKey: "AIzaSyAlb8aLl1kRafLO7GY5rarVly-Z1wMDbz0", authDomain: "bookingsync-ff9bd.firebaseapp.com", databaseURL: "https://bookingsync-ff9bd-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "bookingsync-ff9bd", storageBucket: "bookingsync-ff9bd.appspot.com", messagingSenderId: "269992391466", appId: "1:269992391466:web:b65bc168c948de21796453" };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      let lastSeenTimestamp = null;
      db.ref('server/lastUpdate').on('value', (snapshot) => {
        const timestamp = snapshot.val();
        if (!timestamp) return;
        if (lastSeenTimestamp === null) { lastSeenTimestamp = timestamp; return; }
        if (timestamp !== lastSeenTimestamp) {
          lastSeenTimestamp = timestamp;
          updateBanner.style.display = 'block';
        }
      });
      window.refreshPage = () => { window.location.reload(); };
    });
  </script>
</body>
</html>
