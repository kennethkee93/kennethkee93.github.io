<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Emerald Hills EV Charger Reservation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <base target="_top">

  <!-- PWA Manifest and Icons (from original github.io file) -->
  <link rel="manifest" href="/assets/images/favicons/site.webmanifest">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicons/favicon-16x16.png">
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
  
	
  <!-- External Libraries (from GAS files) -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.18/index.global.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider/distribute/nouislider.min.css">
  
	
  <!-- ALL CSS IS NOW INCLUDED HERE (from styles.txt) -->
  <style>
    /* ===== GLOBAL STYLES ===== */
    html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    max-width: 100vw;
    overflow: hidden; /* Prevents the whole page from scrolling */
    background: #FFFFFF;
    font-family: 'Poppins', Arial, sans-serif;
    color: #000;
    box-sizing: border-box;
    }
    
    /* Make the main wrapper a full-height flex container */
    #mainAppWrapper {
        display: flex; 
        flex-direction: column;
        height: 100vh; /* Full viewport height */
        height: 100dvh; /* Dynamic viewport height for mobile */
        overflow: hidden;
    }
    
    /* ===== HEADER STYLES (Unchanged, but included for context) ===== */
#appHeader {
    display: flex;
    flex: 0 0 auto;
    justify-content: center;
    align-items: center;
    padding: 10px;
    text-align: center;
    z-index: 10;
    overflow: hidden;
    /* Enhanced transition with cubic-bezier for smoother feel */
    transition: 
        padding 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
        box-shadow 0.3s ease-out;
    /* Add backdrop blur for modern effect when shrunk */
    backdrop-filter: blur(0px);
    -webkit-backdrop-filter: blur(0px);
}

/* Enhanced shrunk header state - REMOVED shadow and backdrop effects */
#appHeader.header-shrink {
    padding-top: 5px;
    padding-bottom: 5px;
    /* REMOVED: box-shadow, backdrop-filter, and background-color */
}

/* Enhanced container transitions */
#appHeader > div {
    display: flex;
    align-items: center;
    gap: 15px;
    /* Smoother transition with staggered timing */
    transition: 
        gap 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
        transform 0.3s ease-out;
}

/* Enhanced image container transitions */
#appHeader .image-container {
    width: 60px;
    flex-shrink: 0;
    /* Multi-property transition with different timings */
    transition: 
        width 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
        transform 0.3s ease-out,
        opacity 0.2s ease-in-out;
    /* Prevent layout shift during transition */
    transform-origin: center;
}

/* Enhanced logo transitions */
#appHeader .icon-large {
    max-width: 60px;
    max-height: 60px;
    /* Smooth size and transform transitions */
    transition: 
        max-width 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
        max-height 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
        transform 0.3s ease-out;
    transform-origin: center;
    /* Ensure crisp rendering during transitions */
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}

/* Enhanced H1 base styles */
h1 {
    color: #111827;
    margin: 20px 0;
    text-align: center;
    line-height: 1.2;
    /* Comprehensive text transition */
    transition: 
        font-size 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
        margin 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
        line-height 0.3s ease-out,
        font-weight 0.2s ease-out;
    /* Prevent text rendering issues during transitions */
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Title part transitions */
h1 .title-main-part {
    font-weight: 600;
    transition: font-weight 0.2s ease-out;
}

h1 span:not(.title-main-part) {
    display: block;
    font-weight: 280;
    /* Smooth transition for span elements */
    transition: 
        display 0.1s ease-out,
        font-weight 0.2s ease-out,
        opacity 0.3s ease-out;
}

/* --- ENHANCED SHRUNK STATE TRANSITIONS --- */

/* Shrunk container with subtle scaling effect */
#appHeader.header-shrink > div {
    gap: 8px;
    /* Optional: subtle scale effect for polish */
    transform: scale(0.98);
}

/* Enhanced shrunk image container */
#appHeader.header-shrink .image-container {
    width: 24px;
    /* Slightly faster opacity transition for responsiveness */
    opacity: 0.9;
}

/* Enhanced shrunk logo with micro-animation */
#appHeader.header-shrink .icon-large {
    min-width: 0;
    min-height: 0;
    max-width: 24px;
    max-height: 24px;
    /* Subtle scale adjustment for visual balance */
    transform: scale(1.05);
}

/* Enhanced shrunk H1 with better text flow */
#appHeader.header-shrink h1 {
    font-size: 0.9em;
    line-height: 1;
    margin: 0;
    font-weight: 500;
    /* REMOVED: text-shadow for cleaner look */
}

#appHeader.header-shrink h1 .title-main-part {
    font-weight: 600;
    /* Smooth weight transition */
    transition: font-weight 0.2s ease-out;
}

/* Enhanced span transition for inline display */
#appHeader.header-shrink h1 span {
    display: inline;
    font-weight: 280;
    /* Smooth transition when changing from block to inline */
    transition: all 0.3s ease-out;
}

/* Space addition with smooth transition */
#appHeader.header-shrink h1 span::before {
    content: " ";
    /* Animate the space insertion */
    opacity: 1;
    transition: opacity 0.2s ease-in;
}

/* --- ADDITIONAL ENHANCEMENTS --- */

/* Add hover effects for interactive feel */
#appHeader:not(.header-shrink):hover .icon-large {
    transform: scale(1.05);
}

#appHeader.header-shrink:hover .icon-large {
    transform: scale(1.1);
}

/* Smooth focus states for accessibility */
#appHeader:focus-within {
    outline: 2px solid rgba(59, 130, 246, 0.5);
    outline-offset: 2px;
    transition: outline 0.2s ease-out;
}

/* Reduce motion for users who prefer it */
@media (prefers-reduced-motion: reduce) {
    #appHeader,
    #appHeader > div,
    #appHeader .image-container,
    #appHeader .icon-large,
    h1,
    h1 .title-main-part,
    h1 span:not(.title-main-part) {
        transition-duration: 0.1s;
    }
    
    #appHeader.header-shrink > div {
        transform: none;
    }
    
    #appHeader.header-shrink .icon-large,
    #appHeader:hover .icon-large,
    #appHeader.header-shrink:hover .icon-large {
        transform: none;
    }
}
        
    /* ===== TAB SYSTEM (Revised for Safe Area) ===== */
    #tabButtons {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: #111827;
        box-shadow: 0 -2px 10px #111827;
        display: flex;
        justify-content: space-around;
        gap: 12px;
        padding: 10px 0;
        z-index: 999;
        border-radius: 25px 25px 0 0;
        /* CRITICAL: Adds space at the bottom for the iPhone home bar */
        padding-bottom: env(safe-area-inset-bottom); 
    }
    
    .tab-icon {
        width: 25px;
        height: 25px;
        margin-bottom: 4px;
        display: block;
        margin-left: auto;
        margin-right: auto;
        transition: filter 0.3s ease;
        -webkit-user-drag: none;
        user-drag: none;
    }
    
    .tab-btn {
        position: relative;
        background: transparent;
        overflow: hidden;
        border: none;
        padding: 10px 0;
        font-weight: bold;
        color: #656b76;
        border-radius: 10px;
        font-size: 14px;
        flex: 1;
        margin: 0 5px;
        cursor: pointer;
        transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    .tab-btn::before {
        display: none;
    }
    
    .tab-btn.active {
        transform: scale(1.08);
        color: #e4e5e7;
        background: none;
        background-clip: initial;
        -webkit-background-clip: initial;
        -webkit-text-fill-color: initial;
        text-fill-color: initial;
    }
    
    .tab-btn.active .tab-icon {
        filter: brightness(0) saturate(100%) invert(88%) sepia(2%) saturate(167%) hue-rotate(187deg) brightness(98%) contrast(95%);
    }
    
    .tab-btn:not(.active) .tab-icon {
        filter: brightness(0) saturate(100%) invert(38%) sepia(8%) saturate(377%) hue-rotate(186deg) brightness(92%) contrast(85%);
        transition: filter 0.3s ease;
    }
    
    /* ===== TAB CONTENT PANELS (Revised for Flexbox & Scrolling) ===== */
    #tabContent {
        flex: 1 1 auto; /* This makes the content area grow to fill available space */
        overflow: hidden; /* This contains the absolutely positioned panels */
        position: relative;
    }
    
    .tab-panel {
        position: absolute;
        top: 0;
        left: 0; 
        right: 0; 
        bottom: 0;
        overflow-y: auto; /* This makes the PANEL, not the body, scrollable */
        -webkit-overflow-scrolling: touch;
        transition: transform 0.4s ease, opacity 0.4s ease;
        opacity: 0;
        pointer-events: none;
        z-index: 0;
        /* CRITICAL: Prevents content from being hidden behind the bottom tab bar */
        padding-bottom: calc(90px + env(safe-area-inset-bottom));
    }
    
    .tab-panel.active {
        transform: translateX(0);
        opacity: 1;
        pointer-events: auto;
        z-index: 10;
    }
    
    .tab-panel.slide-in-left { transform: translateX(0); opacity: 1; }
    .tab-panel.slide-in-right { transform: translateX(0); opacity: 1; }
    .tab-panel.slide-out-left { transform: translateX(-100%); opacity: 0; }
    .tab-panel.slide-out-right { transform: translateX(100%); opacity: 0; }

    /* ===== COMMON ELEMENTS ===== */
    .image-container { width: 100%; }
    .icon { width: 32px; height: 32px; margin: 0px; }
    .icon-charging { width: 14px; height: 14px; margin: 0px; }
    .icon-large {
        min-width: 50px; min-height: 50px; width: 100%; height: auto;
        max-width: 70px; max-height: 70px; display: block; margin: 0 auto;
    }

    /* ===== CHARGER STATUS ===== */
    #chargerStatusContainer {
        background: #FFF; padding: 20px; padding-bottom:100px; box-sizing: border-box; color: #eee;
        flex-grow: 1; flex-shrink: 0; max-width: 1200px; display: flex;
        flex-direction: column; gap: 15px; margin: 10px auto; overflow: hidden;
    }
    .charger-status-item { padding: 12px; border-radius: 12px; display: flex; flex-direction: column; gap: 5px; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); background: #FFFFF; transition: background 0.3s ease, border 0.3s ease; }
    .charger-status-item strong { font-size: 1.1em; color: #1e2128; }
    .charger-status-item .status-text { font-size: 0.95em; color: #1e2128; font-weight: 500; }
    .charger-status-item.vacant { background: #E5E7EB; color: #2D3748; border: 1px solid #E5E7EB; }
    .charger-status-item.occupied { background: #ebe8e3; color: #2D3748; border: 1px solid #ebe8e3; }
    .charger-status-item.upcoming { background: #E5E7EB; color: #2D3748; border: 1px solid #E5E7EB; }
    .charger-status-item .time-left { font-size: 0.90em; font-weight: 600; color: #2D3748; background: rgba(255,255,255,0.3); padding: 4px 8px; border-radius: 6px; display: inline-block; }
    .progress-bar-container { background-color: #e0e0e0; border-radius: 12px; overflow: hidden; height: 12px; width: 100%; margin-top: 8px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
    .progress-bar { height: 100%; width: 0%; transition: width 1s linear; }
    .progress-bar.active { background: linear-gradient(45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 222, 222, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent); background-size: 40px 40px; background-color: rgba(255, 165, 0, 0.6); animation: moveStripes 1s linear infinite; }
    .progress-bar.green.active { background: linear-gradient(45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 222, 222, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent); background-size: 40px 40px; background-color: rgba(0, 200, 0, 0.6); animation: moveStripes 1s linear infinite; }
    @keyframes moveStripes { from { background-position: 0 0; } to { background-position: 40px 0; } }
    .upcoming-session { background: #FFF; border-radius: 8px; padding: 10px; margin-top: 8px; border-left: 3px solid #faa756; line-height: 1.3; }
    .upcoming-session strong { font-size: 1em; color: #1e2128; }
    .upcoming-session .status-text { font-size: 0.9em; color: #1e2128; }
    .upcoming-session .starts-in { font-size: 0.85em; color: #1e2128; font-style: italic; font-weight: bold; }

    /* ===== MODAL STYLES ===== */
    #eventModal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); align-items: center; justify-content: center; }
    #eventModal>div { background: #111827; color: #e4e5e7; padding: 20px; border-radius: 10px; max-width: 400px; width: 90%; box-sizing: border-box; box-shadow: 0 0 10px #111827; font-family: 'Poppins', Arial, sans-serif; position: relative; }
    #closeModal { position: absolute; top: 10px; right: 10px; background: transparent; border: none; font-size: 20px; color: #c7e7f0; cursor: pointer; }
    #modalTitle { margin-top: 0; color: #FFFF; }
    #modalContent { white-space: pre-wrap; font-size: 14px; font-family: 'Poppins', Arial, sans-serif; margin-top: 10px; }
    
    /* DateTime Picker Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }
    .modal-content {
        width: calc(100% - 20px);
        max-width: 420px;
        background: #fff;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        box-sizing: border-box;
        position: relative;
    }
    .modal-content h2 { text-align: center; margin-top: 0; font-weight: 600; color: #2c3e50; }
    .close-button {
        position: absolute;
        top: 10px;
        right: 15px;
        background: none;
        border: none;
        font-size: 28px;
        line-height: 1;
        color: #8898aa;
        cursor: pointer;
    }
    
    /* Styles for Flatpickr and noUiSlider */
    .calendar-wrapper {
    display: flex;
    justify-content: center;
    }
    
    /* 2. Remove any conflicting styles from the direct container */
    #date-calendar {
        /* This element no longer needs centering styles */
    }
    
    /* 3. Ensure the calendar itself doesn't force a full width */
    #date-calendar .flatpickr-calendar {
        /* Let the calendar determine its own width based on its content */
        width: auto;
        box-shadow: none;
        border: none;
    }
    
    /* (The rest of your flatpickr day/weekday styles are correct and can remain) */
    #date-calendar .flatpickr-weekdays { display: flex; }
    #date-calendar .flatpickr-weekday { flex: 1; text-align: center; font-weight: 500; }
    #date-calendar .flatpickr-day { flex-basis: 14.28%; max-width: none; height: 38px; line-height: 38px; border-radius: 50%; }
    .flatpickr-day.in-range, .flatpickr-day.in-preview-range { background: #eef2fe; border-color: transparent; border-radius: 0; }
    .flatpickr-day.start-date { background: #5e72e4; color: #fff; border-radius: 50px 0 0 50px; }
    .flatpickr-day.end-date { background: #f5365c; color: #fff; border-radius: 0 50px 50px 0; }
    .flatpickr-day.start-date.end-date { border-radius: 50px; }
    .time-selector-group { margin-top: 25px; }
    .time-selector-group label { display: block; font-size: 14px; font-weight: 500; color: #34495e; margin-bottom: 15px; }
    .time-selector-group label span { float: right; font-weight: 600; background-color: #f0f3f5; padding: 3px 8px; border-radius: 5px; }
    .time-slider { height: 8px; border: none; }
    #start-time-slider .noUi-connect { background: #5e72e4; }
    #start-time-slider .noUi-handle { background: #5e72e4; }
    #end-time-slider .noUi-connect { background: #f5365c; }
    #end-time-slider .noUi-handle { background: #f5365c; }
    .noUi-handle {
        height: 22px !important; width: 22px !important; top: -9px; right: -11px;
        border-radius: 50% !important; border: 3px solid white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2); cursor: grab;
        box-sizing: border-box !important; 
    }
    .noUi-handle:focus { outline: none; }
    .noUi-handle::before, .noUi-handle::after { display: none; } 
    .summary-display { border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 25px 0 20px 0; text-align: center; min-height: 50px; display: flex; justify-content: center; align-items: center; }
    .summary-text { font-size: 15px; font-weight: 500; color: #34495e; }
    .summary-placeholder { color: #8898aa; }
    .apply-button { width: 100%; padding: 15px; background-color: #2dce89; border: none; border-radius: 8px; color: white; font-size: 18px; font-weight: 600; cursor: pointer; }
    .apply-button:disabled { background-color: #a1e9c9; opacity: 0.7; cursor: not-allowed; }

    /* ===== CALENDAR SYSTEM ===== */
    .calendarfilter-container, .calendar-container { width: 100%; max-width: 1200px; margin: 0 auto; box-sizing: border-box; overflow: hidden; flex-shrink: 0; position: relative; }
    .calendar-container { padding-top: 5px; padding-bottom: 100px; }
    #calendar { width: 100%; max-width: 100%; height: auto; background: #fff; color: #111827; border-radius: 10px; border-color: #F7FAFC; padding: 10px; box-sizing: border-box; min-height: 520px; position: relative; z-index: 1; box-shadow: 0 0 10px #F7FAFC; touch-action: pan-y; }
    .fc-day-today { background: #e4e5e7 !important; border: none !important; } 
    #calendar .fc-view-harness, #calendar .fc-scroller, #calendar .fc-timegrid-body { touch-action: pan-y !important; }
    .fc-event, input, textarea, select, button { touch-action: manipulation; }
    #calendar .fc { touch-action: pan-y; }
    .fc-scroller, .fc-event, .fc-daygrid-event { pointer-events: auto !important; }

    /* ===== FILTER CONTROLS ===== */
    .filter-controls { margin: 10px 0 5px 0; width: 100%; max-width: 1200px; display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(2, auto); gap: 8px 12px; justify-items: center; }
    .filter-btn { padding: 7px 10px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; color: #2D3748; font-size: 14px; width: 100%; max-width: 150px; box-sizing: border-box; user-select: none; background-color: #F7FAFC; transition: background-color 0.3s ease, box-shadow 0.3s ease, outline 0.3s ease, transform 0.2s ease; }
    .filter-btn.active { box-shadow: 0 0 0 2px #545454, 0 0 0 4px #fff; transform: translateY(-2px); }
    .filter-btn-all { background-color: #E5E7EB; }
    .filter-btn-a { background-color: #3B82F6; color: #FFFFFF; }
    .filter-btn-b { background-color: #10B981; color: #FFFFFF; }
    .filter-btn-N1 { background-color: #b11879; color: #FFFFFF; }
    .filter-btn-N2 { background-color: #ff3032; color: #FFFFFF; }
    .filter-btn-club { background-color: #F59E0B; color: #FFFFFF; }

    /* ===== BOOKING FORM ===== */
    .form-and-status-wrapper { display: flex; flex-wrap: wrap; justify-content: center; align-items: flex-start; width: 100%; max-width: 1200px; margin: 20px auto; }
    #bookingForm { width: 100%; max-width: 1200px; flex-grow: 1; flex-shrink: 0; background: #FFFFF; padding: 20px; padding-bottom: 100px; border-radius: 10px; box-sizing: border-box; color: #545454; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); overflow: hidden; margin: 0 auto; }
    #bookingForm input, #bookingForm select, #bookingForm button { padding: 10px; margin: 8px 0; width: 100%; border-radius: 10px; border: none; box-sizing: border-box; font-size: 15px; }
    #bookingForm input, #bookingForm select { font-family: 'Poppins', Arial, sans-serif; background: #e8e9eb; color: #545454; }
    #bookingForm input::placeholder { color: #aaa; }
    #bookingForm .charger-btn.filter-btn-a { background-color: #3B82F6; color: #FFFFFF; }
    #bookingForm .charger-btn.filter-btn-b { background-color: #10B981; color: #FFFFFF; }
    #bookingForm .charger-btn.filter-btn-club { background-color: #F59E0B; color: #FFFFFF; }
    #bookingForm .charger-btn.filter-btn-N1 { background-color: #b11879; color: #FFFFFF; }
    #bookingForm .charger-btn.filter-btn-N2 { background-color: #ff3032; color: #FFFFFF; }
    #chargerButtons { margin: 0 auto; display: flex; flex-direction: column; gap: 8px; padding: 0 5px; }
    .row { display: flex; gap: 8px; }
    .row-top, .row-bottom { justify-content: center; }
    .charger-btn { display: inline-flex; justify-content: center; align-items: center; text-align: center; padding: 10px 16px; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; font-size: 14px; user-select: none; transition: all 0.3s ease; }
    .charger-btn:hover { box-shadow: 0 0 0 2px #545454, 0 0 0 4px #fff; }
    .charger-btn.selected { outline: 3px solid #000000; box-shadow: 0 0 0 2px #545454, 0 0 0 4px #fff; transform: translateY(-2px); }
    .save-info-label { display: flex !important; align-items: center; justify-content: center; margin: 10px auto; width: fit-content; gap: 4px; }
    .save-info-label input[type="checkbox"] { margin: 0 !important; width: auto !important; height: 14px; flex-shrink: 0; }
    .save-info-label span { white-space: nowrap; }
    #bookingForm button { background: #656b76; color: #e4e5e7; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease; }
    #bookingForm button:hover:not(:disabled) { background: #111827; }
    #bookingForm button:disabled { opacity: 0.6; cursor: not-allowed; }
    .error, .success { padding: 10px; border-radius: 10px; margin: 10px 0; display: none; font-weight: bold; text-align: center; }
    .error { background: #ff3333; color: white; }
    .success { background: #00cc66; color: white; }

    /* ===== SIDE BUTTONS ===== */
    #sideButtonsWrapper { display: flex; align-items: flex-end; gap: 8px; position: fixed; bottom: calc(80px + env(safe-area-inset-bottom)); right: 20px; z-index: 1000; font-family: Arial, sans-serif; flex-direction: column; }
    #sideButtonsExpandedGroup { display: flex; flex-direction: column; gap: 8px; transition: all 0.3s ease-out; opacity: 0; transform: translateY(50px); pointer-events: none; max-height: 0; overflow: hidden; align-items: flex-end; }
    #sideButtonsExpandedGroup.show-expanded { opacity: 1; transform: translateY(0); pointer-events: auto; max-height: 500px; overflow: visible; }
    .side-button-group { position: relative; }
    .side-btn { background-color: white; opacity: 1; border: none; color: white; font-size: 16px; padding: 1px 1px; border-radius: 8px; cursor: pointer; user-select: none; transition: background-color 0.5s ease; min-width: 44px; min-height: 44px; display: flex; justify-content: center; align-items: center; }
    @keyframes rotate360 { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .side-btn:hover, .side-btn:focus { background-color: #ededed; opacity: 1; outline: none; animation: rotate360 0.6s ease; }
    .side-panel { display: none; position: absolute; bottom: 50px; right: 0; width: 320px; max-width: 90vw; background: white; border: 1px solid #ccc; border-radius: 8px; padding: 15px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); font-size: 14px; color: #333; z-index: 1001; max-height: 400px; overflow-y: auto; }
    .side-panel.show { display: block; }
    form#feedbackForm fieldset { border: 1px solid #ddd; margin-bottom: 12px; padding: 10px; border-radius: 6px; }
    form#feedbackForm legend { font-weight: bold; padding: 0 6px; }
    form#feedbackForm textarea { width: 100%; resize: vertical; font-family: inherit; font-size: 14px; padding: 6px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
    form#feedbackForm label { cursor: pointer; margin-right: 10px; }
    #feedbackSubmitBtn { width: 100%; margin-top: 10px; background: #111827; color: #e4e5e7; cursor: pointer; transition: background-color 0.3s ease; }
    #feedbackMessage { margin-top: 10px; min-height: 18px; font-weight: 600; }
    #helpPanel a { color: #18db80; text-decoration: underline; transition: color 0.2s ease; }
    #helpPanel a:hover { color: #06806b; text-decoration: none; }
    
    /* ===== PWA UPDATE & FIREBASE NOTIFICATIONS (from original github.io file) ===== */
    #update-notification { display: none; position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100%); background: #fffbe6; border: 1px solid #ffecb3; padding: 16px 20px; text-align: center; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1000; animation: slideIn 0.4s forwards; transition: transform 0.4s ease, opacity 0.4s ease; }
    #update-notification p { margin: 0; font-size: 14px; color: #333; }
    #update-notification button { margin-top: 10px; padding: 8px 16px; background-color: #378fee; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; }
    .dismiss-notification { transform: translateX(-50%) translateY(50px); opacity: 0; }
    @keyframes slideIn { to { transform: translateX(-50%) translateY(0%); } }
    @keyframes smoothSlideOut { to { transform: translateX(-50%) translateY(50px); opacity: 0; } }
    #updateToast { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: #fff; padding: 14px 24px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 1000; font-family: sans-serif; text-align: center; max-width: 90vw; box-sizing: border-box; }
    #updateToast div { margin-bottom: 8px; white-space: nowrap; }
    #refreshBtn { padding: 6px 12px; background-color: #4CAF50; border: none; color: white; border-radius: 4px; cursor: pointer; }

    /* MEDIA QUERIES (from styles.txt, UNCHANGED) */
    @media (max-width: 768px) {
      body { min-height: 100%; height: auto; overflow-x: hidden; overflow-y: auto; padding: 10px; font-size: 14px; -webkit-overflow-scrolling: touch; }
      .tab-icon { width: 20px; height: 20px; }
      .tab-btn { padding: 5px 0px; font-size: 10px; }
      #tabContent { width: 100%; max-width: 1200px; margin-bottom: 20px; }
      .icon-large { width: 35px; height: 35px; max-width: 35px; max-height: 35px; }
      .icon-charging { width: 12px; height: 12px; }
      h1 { font-size: 1.3em; margin-bottom: 15px; line-height: 1.3; }
      #calendar { padding: 8px; }
      .fc .fc-toolbar { flex-direction: row; gap: 3px; }
      .fc .fc-toolbar .fc-button-group { display: flex; justify-content: center; }
      .fc .fc-toolbar .fc-button { font-size: 10px; padding: 1px 1px; margin: 0 1px; }
      .fc .fc-toolbar-title { font-size: 12px; text-align: center; margin: 1px 0; }
      .fc .fc-day-today { background: #e4e5e7 !important; border: none !important; } 
      .fc-timeGridWeek-view .fc-col-header { position: sticky; top: 0; background: #ffffff; z-index: 5; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      .fc-timegrid-body { overflow-y: auto; }
      .fc .fc-timegrid-slot { height: 10px !important; min-height: 10px !important; padding: 0 !important; }
      .fc .fc-col-header-cell-cushion { font-size: 9px !important; }
      .fc .fc-timegrid-slot-label { font-size: 9px !important; padding: 0 4px !important; height: 10px !important; line-height: 10px !important; }
      .fc .fc-event { font-size: 9px; padding: 2px; white-space: normal !important; overflow-wrap: break-word; word-break: break-word; height: auto !important; min-height: 20px; }
      .fc .fc-event-main { display: block !important; width: 100% !important; }
      .fc .fc-event-title, .fc .fc-event-title-container { font-size: 9px; display: block !important; width: 100% !important; overflow-wrap: break-word; word-break: break-word; white-space: normal !important; }
      .fc-timegrid-event .fc-event-main { white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; display: block !important; }
      .fc .fc-daygrid-day-number { font-size: 12px; padding: 4px; }
      .fc .fc-daygrid-event { font-size: 12px; margin-bottom: 1px; }
      .filter-controls { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, auto); gap: 6px; width: 100%; padding: 0 2px; box-sizing: border-box; }
      .filter-btn { padding: 6px 8px; font-size: 12px; border-radius: 8px; width: 100%; box-sizing: border-box; }
      .form-and-status-wrapper { width: 100%; max-width: 100%; box-sizing: border-box; padding: 0; }
      #bookingForm { width: 100%; max-width: 100%; padding: 15px; border-radius: 8px; overflow-x: hidden; }
      #bookingForm input, #bookingForm select, #bookingForm button { font-size: 12px; padding: 12px; margin: 6px 0; border-radius: 8px; }
      #chargerButtons { max-width: 768px; margin: 0 auto; display: flex; flex-direction: column; gap: 8px; padding: 0 5px; }
      .row { display: flex; gap: 8px; }
      .row-top, .row-bottom { justify-content: center; }
      .charger-btn { width: 100px; flex: 0 0 100px; padding: 10px; font-size: 12px; border-radius: 8px; }
      #chargerStatusContainer { padding: 15px; max-width: none; gap: 12px; }
      .charger-status-item { padding: 10px; gap: 6px; }
      .charger-status-item strong { font-size: 1em; }
      .charger-status-item .status-text { font-size: 0.9em; }
      .upcoming-session { padding: 8px; margin-top: 6px; }
      .upcoming-session strong { font-size: 0.9em; }
      .upcoming-session .status-text { font-size: 0.85em; line-height: 1.2; }
      .upcoming-session .starts-in { font-size: 0.85em; }
      #eventModal>div { margin: 10px; padding: 15px; max-width: none; width: calc(100% - 20px); border-radius: 8px; }
      #modalTitle { font-size: 1.1em; padding-right: 30px; }
      #modalContent { font-size: 13px; line-height: 1.4; }
      #closeModal { font-size: 18px; padding: 5px; }
    }
    @media (max-width: 480px) {
      body { padding: 8px; }
      h1 { font-size: 1.2em; margin-bottom: 12px; }
      #calendar { padding: 5px; }
      .fc .fc-toolbar { flex-wrap: nowrap; flex-direction: row; align-items: center; justify-content: space-between; gap: 1px; }
      .fc .fc-toolbar .fc-button-group { display: flex; flex-direction: row; flex-wrap: nowrap; gap: 0px; }
      .fc .fc-toolbar .fc-button { font-size: 10px; padding: 1px 2px; margin: 0; min-width: auto; white-space: nowrap; }
      .fc .fc-toolbar-title { font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; margin: 0 4px; flex: 1; text-align: center; }
      .filter-controls { grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, auto); gap: 6px; padding: 0 5px; }
      .filter-btn { padding: 6px; font-size: 11px; max-width: none; }
      #bookingForm { padding: 12px; }
      #bookingForm input, #bookingForm select, #bookingForm button { font-size: 11px; padding: 10px; }
      #sideButtonsWrapper { bottom: calc(80px + env(safe-area-inset-bottom)); right: 10px; gap: 6px; }
      .side-btn { font-size: 14px; min-width: 36px; min-height: 36px; border-radius: 8px; }
      .side-panel { bottom: 60px; left: 45%; transform: translateX(-100%); width: calc(80vw - 50px); max-height: 350px; font-size: 12px; }
      #eventModal>div { margin: 5px; padding: 12px; width: calc(100% - 10px); }
    }
  </style>
</head>
<body>
  
  <!-- The main app UI now lives here, NOT in an iframe -->
  <div id="appHeader">
    <div style="display: flex; align-items: center; gap: 30px;">
      <div class="image-container">
        <img class="icon icon-large" src="https://github.com/emeraldevbooking/emeraldevbooking.github.io/blob/main/assets/images/favicons/android-chrome-192x192.png?raw=true" alt="Main Icon">
      </div>
      <h1 style="margin: 0; white-space: nowrap;">
            <span class="title-main-part">Emerald Hills</span>
         <span>EV Charger Reservation</span>
      </h1>
    </div>
  </div>

  <div id="mainAppWrapper">
    <!-- Tab Panels -->
    <div id="tabContent">
      <!-- Status Panel -->
      <div id="statusPanel" class="tab-panel active">
          <div id="chargerStatusContainer">
            <div id="statusTowerA" class="charger-status-item"></div>
            <div id="statusTowerB" class="charger-status-item"></div>
            <div id="statusClubhouse" class="charger-status-item"></div>
          </div>
      </div>
      <!-- Calendar Panel -->
      <div id="calendarPanel" class="tab-panel">
        <div class="calendarfilter-container">
          <div class="filter-controls" role="group" aria-label="Filter chargers">
              <button class="filter-btn filter-btn-all active" data-charger="all" type="button" aria-pressed="true">All</button>
              <button class="filter-btn filter-btn-a" data-charger="Tower A" type="button" aria-pressed="false">Tower A</button>
              <button class="filter-btn filter-btn-b" data-charger="Tower B" type="button" aria-pressed="false">Tower B</button>
              <button class="filter-btn filter-btn-club" data-charger="Clubhouse" type="button" aria-pressed="false">Clubhouse</button>
          </div>
          <div class="calendar-container">
            <div id="calendar"></div>
          </div>
        </div>
      </div>
      <!-- Booking Form Panel -->
      <div id="formPanel" class="tab-panel">
        <div class="form-and-status-wrapper">
          <form id="bookingForm" method="POST" autocomplete="on" novalidate>
            <div id="errorMsg" class="error" role="alert"></div>
            <div id="successMsg" class="success" role="status"></div>
            <input id="name" name="name" type="text" autocomplete="name" placeholder="Name of Car Owner" required oninput="convertToTitleCase(this)" />
            <input id="plate" name="license_plate" type="text" autocomplete="nickname" placeholder="Car Plate Number" required oninput="this.value = this.value.toUpperCase()" />
            <input id="phone" name="tel" type="tel" autocomplete="tel" placeholder="Phone Number" pattern="[0-9]*" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '');" />
            <input id="email" name="email" type="email" autocomplete="email" placeholder="Email for Confirmation (Required)" required />
            
            <div id="chargerButtons">
              <div class="row row-top">
                <button type="button" class="charger-btn filter-btn-a" data-charger="Tower A">Tower A</button>
                <button type="button" class="charger-btn filter-btn-b" data-charger="Tower B">Tower B</button>
                <button type="button" class="charger-btn filter-btn-club" data-charger="Clubhouse">Clubhouse</button>
              </div>
            </div>
            
            <input type="hidden" id="charger" name="charger" required/>
            
            <!-- NEW VISIBLE inputs that open the modal -->
            <label for="start_display">Start Date & Time</label>
            <input id="start_display" name="start_display" type="text" placeholder="Tap to select date & time" readonly style="cursor: pointer;"/>
            
            <label for="end_display" style="margin-top:10px;">End Date & Time</label>
            <input id="end_display" name="end_display" type="text" placeholder="Tap to select date & time" readonly style="cursor: pointer;"/>
            
            <!-- ORIGINAL HIDDEN inputs that store the final ISO date for submission -->
            <input id="start_datetime" name="start_datetime" type="hidden" required />
            <input id="end_datetime" name="end_datetime" type="hidden" required />
            
            <label class="save-info-label"><input type="checkbox" id="rememberMe" />Autofill my information in the next reservation</label>
            
            <button type="submit">Reserve</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Buttons -->
  <div id="tabButtons">
    <button class="tab-btn active" onclick="showTab('status')"><img src="https://cdn-icons-png.flaticon.com/128/10024/10024154.png" class="tab-icon"><span>Status</span></button>
    <button class="tab-btn" onclick="showTab('calendar')"><img src="https://cdn-icons-png.flaticon.com/128/18349/18349398.png" class="tab-icon"><span>Calendar</span></button>
    <button class="tab-btn" onclick="showTab('form')"><img src="https://cdn-icons-png.flaticon.com/128/16491/16491307.png" class="tab-icon"><span>Reserve</span></button>
  </div>

  <!-- Side Buttons and Panels -->
  <div id="sideButtonsWrapper">
      <div id="sideButtonsExpandedGroup">
          <div class="side-button-group">
              <button id="helpBtn" class="side-btn"><img class="icon" src="https://cdn-icons-gif.flaticon.com/11688/11688376.gif" alt="Help"></button>
              <div id="helpPanel" class="side-panel">
                    <strong>Reservation Cancellation Notice</strong><br>
                    If you wish to cancel a reservation you made, please use the cancellation link provided in your booking confirmation email. <br><br>
                    <strong>Having issues with Your Reservation?</strong><br>
                    <span style="font-size:1.2em;"><img class="icon" src="https://cdn-icons-png.flaticon.com/128/13670/13670447.png" alt="Whatsapp Icon" style="width:15px; height:auto;">
                    </span> Contact us via WhatsApp:<br>
                    Ken - <a href="https://wa.link/2j8nrw" target="_blank" rel="noopener noreferrer">Chat with Ken</a><br>
                    Max - <a href="https://wa.link/soelvy" target="_blank" rel="noopener noreferrer">Chat with Max</a><br><br>
                    We're happy to assist with any modifications or cancellations to your reservation.<br><br>
                    <strong>Join the Community!</strong><br>
                    Connect with other EV owners in Emerald Hills by joining our WhatsApp group:<br>
                    <a href="https://chat.whatsapp.com/Ja1eSJSGug20nj1Wqk3OtP" target="_blank" rel="noopener noreferrer">Emerald Hills EV Owners Group</a><br><br><br><br>
                  Â© <span id="copyrightYear"></span>. Version 2.0
              </div>
          </div>
          <div class="side-button-group">
              <button id="faqBtn" class="side-btn"><img class="icon" src="https://cdn-icons-gif.flaticon.com/12205/12205155.gif" alt="FAQ"></button>
              <div id="faqPanel" class="side-panel">
                    <strong>Frequently Asked Questions (FAQ)</strong><br><br>
                    <strong>Q: Who created this web app?</strong><br>
                    This web app was developed by members of the Emerald Hills EV community to support efficient scheduling and communication regarding EV charger reservations. It is a community-driven initiative designed to enhance coordination among residents and EV owners.<br><br>
                    <strong>Q: Is this web app affiliated with Emerald Hills Management?</strong><br>
                    No, this web app is independent and is not affiliated with Emerald Hills Management in any way. It was created by EV community to streamline charger reservations and improve accessibility for residents who need to charge their vehicles.<br><br>
                    <strong>Q: What is the purpose of this web app?</strong><br>
                    The primary goal of this web app is to facilitate better communication and planning among EV owners regarding charger availability. By allowing users to schedule their charging slots in advance, we aim to minimize conflicts, ensure fair access to chargers, and improve the overall charging experience for everyone in the community.<br><br>
                    <strong>Q: How can I book a charging slot?</strong><br>
                    Users can simply access the reservation system through this web app, select their preferred date and time, and submit a request to book an available charger.<br><br>
                    <strong>Q: How do I cancel a reservation?</strong><br>
                    To cancel a reservation, please use the unique cancellation link provided in your booking confirmation email. This will automatically cancel your reservation.<br><br>
                    <strong>Q: How do I modify my reservation?</strong><br>
                    To make changes to an existing reservation, please cancel your current booking using the unique cancellation link provided in your booking confirmation email. Then, simply submit a new reservation with your updated details.
                </div>
          </div>
          <div class="side-button-group">
              <button id="feedbackBtn" class="side-btn"><img class="icon" src="https://cdn-icons-gif.flaticon.com/15370/15370746.gif" alt="Feedback"></button>
              <div id="feedbackPanel" class="side-panel">
                  <form id="feedbackForm" novalidate>
                      <fieldset><legend>Bug Reporting</legend><label><input type="radio" name="bugEncountered" value="Yes" required> Yes</label> <label><input type="radio" name="bugEncountered" value="No" required> No</label><br><textarea name="bugDetails" placeholder="Please describe the bug" rows="3"></textarea></fieldset>
                      <fieldset><legend>Suggestions</legend><textarea name="suggestions" placeholder="What features would you like to see?" rows="3"></textarea></fieldset>
                      <button type="submit" id="feedbackSubmitBtn" class="side-btn">Submit</button>
                      <div id="feedbackMessage"></div>
                  </form>
              </div>
          </div>
      </div>
      <button id="moreBtn" class="side-btn"><img class="icon" src="https://cdn-icons-gif.flaticon.com/16046/16046406.gif" alt="More Options"></button>
  </div>
  
  <!-- Event Modal -->
  <div id="eventModal"><div id="modalInner"><button id="closeModal">&times;</button><h2 id="modalTitle"></h2><pre id="modalContent"></pre></div></div>
  
  <!-- PWA & Firebase Notifications -->
  <div id="update-notification"><p>ðŸ”” A new reservation has been added.</p><button onclick="refreshPage()">Update Now</button></div>
  <div id="updateToast"><div>ðŸ”„ New version available</div><button id="refreshBtn">Update Now</button></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  
  <!-- Flatpkr and nouislider -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/nouislider/distribute/nouislider.min.js"></script>

  <!-- THE ALL-IN-ONE JAVASCRIPT LOGIC -->
  <script>
    /****************************************************************
     *                  CRITICAL CONFIGURATION                      *
     *   PASTE THE WEB APP URL YOU COPIED FROM STEP 2 BELOW         *
     ****************************************************************/
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyUKONWm1460-OGDShkCicRAF9FHo1DrLVUWziXprCJDpUDiNvW934vV_BBC8Tt115W/exec'; // <-- PASTE YOUR URL HERE!


    /* =================================================================
       CORE APP LOGIC (refactored from script.txt)
       ================================================================= */
    let currentIndex = 0;
    const tabPanels = ['status', 'calendar', 'form'];
    let calendar = null;
    let allEvents = [];
    let tabHeaderState = {};

    // =================================================================
    //        LOGIC FOR THE NEW DATE & TIME PICKER MODAL
    // =================================================================
function initializeDateTimePicker() {
    const modal = document.getElementById('dateTimePickerModal');
    if (!modal) return;

    // --- References to Elements ---
    const summaryTextEl = document.getElementById('summary-text');
    const modalStartEl = document.getElementById('dtp_start_datetime');
    const modalEndEl = document.getElementById('dtp_end_datetime');
    const applyButton = document.getElementById('apply-button');
    const startTimeValueEl = document.getElementById('start-time-value');
    const endTimeValueEl = document.getElementById('end-time-value');
    const startSliderEl = document.getElementById('start-time-slider');
    const endSliderEl = document.getElementById('end-time-slider');
    const mainFormStartDisplay = document.getElementById('start_display');
    const mainFormEndDisplay = document.getElementById('end_display');
    const mainFormStartHidden = document.getElementById('start_datetime');
    const mainFormEndHidden = document.getElementById('end_datetime');

    // --- State Variables ---
    let startDate = null;
    let endDate = null;
    let startTimeInMinutes = 540;  // 9:00 AM
    let endTimeInMinutes = 1020;   // 5:00 PM
    const MINIMUM_SLOT_MINUTES = 15;
    
    // Track if the range was created by midnight crossover
    let wasCreatedByMidnight = false;
    let isUpdatingCalendar = false;

    // --- Helper Functions ---
    function minutesToTimeFormat(minutes) {
        minutes = Math.round(minutes);
        if (minutes === 1440) return '12:00 AM';
        const h = Math.floor(minutes / 60);
        const m = minutes % 60;
        const ampm = h >= 12 ? 'PM' : 'AM';
        let hour12 = h % 12;
        if (hour12 === 0) { hour12 = 12; }
        return `${hour12}:${m < 10 ? '0' + m : m} ${ampm}`;
    }

    function isSingleDaySelection() {
        return !endDate || (startDate && endDate && 
               startDate.getFullYear() === endDate.getFullYear() &&
               startDate.getMonth() === endDate.getMonth() &&
               startDate.getDate() === endDate.getDate());
    }

    function isConsecutiveDays() {
        if (!startDate || !endDate) return false;
        const timeDiff = endDate.getTime() - startDate.getTime();
        const oneDayInMs = 24 * 60 * 60 * 1000;
        return timeDiff === oneDayInMs;
    }

    function updateSummary() {
    const options = { weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true };

    // Priority 1: Check if a start date has been selected yet.
    if (!startDate) {
        summaryTextEl.innerHTML = `<span class="summary-placeholder">Select a start date</span>`;
        applyButton.disabled = true;
        return;
    }
    
    // Priority 2: Check if an end date has been selected yet (in range mode).
    // Note: If they are the same day, it counts as both start and end being selected.
    const isRangeMode = datePicker.config.mode === 'range';
    if (isRangeMode && !endDate) {
        summaryTextEl.innerHTML = `<span class="summary-placeholder">Select an end date</span>`;
        applyButton.disabled = true;
        return;
    }
    
    // If we get here, both dates are selected, so we can calculate and show the full summary.
    const effectiveEndDate = endDate || startDate;

    const finalStart = new Date(startDate);
    finalStart.setHours(Math.floor(startTimeInMinutes / 60), startTimeInMinutes % 60, 0, 0);

    const finalEnd = new Date(effectiveEndDate);
    const endHour = endTimeInMinutes === 1440 ? 0 : Math.floor(endTimeInMinutes / 60);
    const endMinutes = endTimeInMinutes % 60;
    finalEnd.setHours(endHour, endMinutes, 0, 0);

    if (isSingleDaySelection() && endTimeInMinutes === 1440) {
        finalEnd.setDate(finalEnd.getDate() + 1);
    }
    
    if (finalEnd <= finalStart) {
        summaryTextEl.innerHTML = `<span class="summary-placeholder" style="color: #f5365c;">End time must be after start time</span>`;
        applyButton.disabled = true;
        return;
    }
    
    summaryTextEl.innerText = `${finalStart.toLocaleString('en-US', options)} - ${finalEnd.toLocaleString('en-US', options)}`;
    modalStartEl.value = finalStart.toISOString();
    modalEndEl.value = finalEnd.toISOString();
    applyButton.disabled = false;
    }

    // --- Slider Initialization ---
    const startSlider = noUiSlider.create(startSliderEl, {
        start: startTimeInMinutes,
        connect: [true, false],
        step: 15,
        range: { 'min': 0, 'max': 1440 - MINIMUM_SLOT_MINUTES }
    });

    const endSlider = noUiSlider.create(endSliderEl, {
        start: endTimeInMinutes,
        connect: [true, false],
        step: 15,
        range: { 'min': MINIMUM_SLOT_MINUTES, 'max': 1440 }
    });

    // --- Date Picker Initialization ---
    const datePicker = flatpickr("#date-calendar", {
        inline: true,
        minDate: "today",
        disableMobile: true,
        mode: 'range',
        onChange: (selectedDates) => {
            if (isUpdatingCalendar) return;
            
            startDate = selectedDates[0] || null;
            endDate = selectedDates[1] || null;
            
            // When user manually selects dates, reset the midnight flag
            wasCreatedByMidnight = false;
            
            updateSummary();
        }
    });

    // --- Start Time Slider Event Handler ---
    startSlider.on('update', (values) => {
        startTimeInMinutes = Number(values[0]);
        startTimeValueEl.innerText = minutesToTimeFormat(startTimeInMinutes);
        
        const isSingleDay = isSingleDaySelection();

        // SINGLE DAY LOGIC: Ensure end time is always after start time
        if (isSingleDay) {
            if (startTimeInMinutes >= endTimeInMinutes) {
                endSlider.set(startTimeInMinutes + MINIMUM_SLOT_MINUTES);
            }
        }

        updateSummary();
    });

    // --- End Time Slider Event Handler ---
    endSlider.on('update', (values) => {
        endTimeInMinutes = Number(values[0]);
        endTimeValueEl.innerText = minutesToTimeFormat(endTimeInMinutes);

        const isSingleDay = isSingleDaySelection();
        
        // Handle midnight crossover
        if (endTimeInMinutes === 1440 && startDate) {
            if (isSingleDay) {
                // Create next day range for single day selection
                const nextDay = new Date(startDate);
                nextDay.setDate(nextDay.getDate() + 1);
                
                isUpdatingCalendar = true;
                datePicker.setDate([startDate, nextDay], true);
                endDate = nextDay;
                wasCreatedByMidnight = true;
                isUpdatingCalendar = false;
            }
            else if (!wasCreatedByMidnight && isConsecutiveDays()) {
                // Extend consecutive days by one more day when sliding to midnight
                const dayAfterEnd = new Date(endDate);
                dayAfterEnd.setDate(dayAfterEnd.getDate() + 1);
                
                isUpdatingCalendar = true;
                datePicker.setDate([startDate, dayAfterEnd], true);
                endDate = dayAfterEnd;
                wasCreatedByMidnight = true; // Mark as midnight-extended
                isUpdatingCalendar = false;
            }
        }
        // Handle moving away from midnight
        else if (endTimeInMinutes < 1440) {
            if (wasCreatedByMidnight) {
                if (isConsecutiveDays()) {
                    // Revert single day that was extended to range
                    isUpdatingCalendar = true;
                    datePicker.setDate([startDate], true);
                    endDate = null;
                    wasCreatedByMidnight = false;
                    isUpdatingCalendar = false;
                }
                else {
                    // Revert extended consecutive days back to original consecutive days
                    const dayBeforeEnd = new Date(endDate);
                    dayBeforeEnd.setDate(dayBeforeEnd.getDate() - 1);
                    
                    isUpdatingCalendar = true;
                    datePicker.setDate([startDate, dayBeforeEnd], true);
                    endDate = dayBeforeEnd;
                    wasCreatedByMidnight = false; // Reset the flag
                    isUpdatingCalendar = false;
                }
            }
        }
        
        // SINGLE DAY LOGIC: Handle backward adjustment
        const isCurrentlySingleDay = isSingleDaySelection();
        if (isCurrentlySingleDay) {
            if (endTimeInMinutes <= startTimeInMinutes) {
                startSlider.set(endTimeInMinutes - MINIMUM_SLOT_MINUTES);
            }
        }

        updateSummary();
    });

    // --- Modal Control Functions (unchanged logic for smart open) ---
    function openModal() {
        modal.style.display = 'flex';
        const now = new Date();
        const currentMinutes = now.getHours() * 60 + now.getMinutes();
        let roundedStartTime = Math.ceil(currentMinutes / 15) * 15;
        let roundedEndTime = roundedStartTime + 60;
        if (roundedEndTime > 1440) { roundedEndTime = 1440; }
        if (roundedStartTime >= 1440 - MINIMUM_SLOT_MINUTES) { roundedStartTime = 1440 - MINIMUM_SLOT_MINUTES; roundedEndTime = 1440; }
        datePicker.clear();
        startDate = null; endDate = null;
        startSlider.set(roundedStartTime); 
        endSlider.set(roundedEndTime); 
        updateSummary();
    }
    function closeModal() { modal.style.display = 'none'; }

    // --- Final Event Listeners ---
    mainFormStartDisplay.addEventListener('click', openModal);
    mainFormEndDisplay.addEventListener('click', openModal);
    document.getElementById('closeDateTimePicker').addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

    // THE FIX: Simplified applyButton listener, no more "-1 minute" logic
    applyButton.addEventListener('click', () => {
        if (!applyButton.disabled) {
            const startValueISO = modalStartEl.value;
            const endValueISO = modalEndEl.value;
            mainFormStartHidden.value = startValueISO;
            mainFormEndHidden.value = endValueISO;
            const displayOptions = { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true };
            mainFormStartDisplay.value = new Date(startValueISO).toLocaleString('en-US', displayOptions);
            mainFormEndDisplay.value = new Date(endValueISO).toLocaleString('en-US', displayOptions); // Now uses the clean value
            closeModal();
        }
    });

        updateSummary();
    }  

      function showTab(tab) {
          const header = document.getElementById('appHeader');
          const panels = {
              status: document.getElementById('statusPanel'),
              calendar: document.getElementById('calendarPanel'),
              form: document.getElementById('formPanel'),
          };
          const newIndex = tabPanels.indexOf(tab);
          if (newIndex === currentIndex) return;
      
          // Rule #1: Always expand the header when switching to a new tab.
          header.classList.remove('header-shrink');
      
          const direction = (newIndex < currentIndex) ? 'right' : 'left';
          Object.values(panels).forEach(p => p.classList.remove('slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right'));
          
          const currentPanel = panels[tabPanels[currentIndex]];
          const nextPanel = panels[tabPanels[newIndex]];
          
          currentPanel.classList.remove('active');
          currentPanel.classList.add(direction === 'left' ? 'slide-out-left' : 'slide-out-right');
          nextPanel.classList.add('active');
          nextPanel.classList.add(direction === 'left' ? 'slide-in-left' : 'slide-in-right');
      
          setTimeout(() => {
              currentPanel.classList.remove('slide-out-left', 'slide-out-right');
              nextPanel.classList.remove('slide-in-left', 'slide-in-right');
          }, 400);
      
          document.querySelectorAll('#tabButtons .tab-btn').forEach(btn => btn.classList.remove('active'));
          document.querySelector(`.tab-btn[onclick*="showTab('${tab}')"]`)?.classList.add('active');
          currentIndex = newIndex;
      
          // Rule #2: After switching, check the saved state and re-shrink if necessary.
          const newPanelId = nextPanel.id;
          if (tabHeaderState[newPanelId]) {
              header.classList.add('header-shrink');
          }
      
          if (tab === 'calendar' && calendar) setTimeout(() => calendar.render(), 0);
      }
    
      document.addEventListener('DOMContentLoaded', function() {
        
        initializeDateTimePicker(); 
                
        // Helper function to show a tab by its numerical index (used by both swipe listeners)
        function showTabByIndex(index) {
            if (index < 0) { index = 0; }
            if (index >= tabPanels.length) { index = tabPanels.length - 1; }
            const tabName = tabPanels[index];
            showTab(tabName);
        }
    
        // Listener 1: Hammer.js swipe navigation for the MAIN CONTENT AREA
        const appWrapper = document.getElementById('mainAppWrapper');
        const hammerManager = new Hammer(appWrapper, {
            recognizers: [
                [Hammer.Swipe, { direction: Hammer.DIRECTION_HORIZONTAL }]
            ]
        });
    
        hammerManager.on('swipeleft', (e) => {
            if (e.target.closest('#calendar')) { return; } // Ignore swipes on calendar
            showTabByIndex(currentIndex + 1);
        });
    
        hammerManager.on('swiperight', (e) => {
            if (e.target.closest('#calendar')) { return; } // Ignore swipes on calendar
            showTabByIndex(currentIndex - 1);
        });
    
        // Listener 2: Hammer.js swipe navigation for the BOTTOM TAB BAR
        const tabBar = document.getElementById('tabButtons');
        const tabBarHammer = new Hammer(tabBar);
    
        tabBarHammer.on('swipeleft', () => {
            showTabByIndex(currentIndex + 1);
        });
    
        tabBarHammer.on('swiperight', () => {
            showTabByIndex(currentIndex - 1);
        });
    
        // Side buttons logic
        const buttons = [{ btnId: 'helpBtn', panelId: 'helpPanel' }, { btnId: 'faqBtn', panelId: 'faqPanel' }, { btnId: 'feedbackBtn', panelId: 'feedbackPanel' }];
        const moreBtn = document.getElementById('moreBtn');
        const expandedGroup = document.getElementById('sideButtonsExpandedGroup');
        let openPanel = null;
        function closeAllIndividualPanels() {
            buttons.forEach(({ btnId, panelId }) => {
                document.getElementById(btnId).setAttribute('aria-expanded', 'false');
                const panel = document.getElementById(panelId);
                panel.classList.remove('show');
                panel.setAttribute('aria-hidden', 'true');
            });
            openPanel = null;
        }
        buttons.forEach(({ btnId, panelId }) => {
            const button = document.getElementById(btnId);
            const panel = document.getElementById(panelId);
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const isExpanded = button.getAttribute('aria-expanded') === 'true';
                buttons.forEach(b => { if (b.btnId !== btnId) { document.getElementById(b.btnId).setAttribute('aria-expanded', 'false'); document.getElementById(b.panelId).classList.remove('show'); } });
                if (!isExpanded) { button.setAttribute('aria-expanded', 'true'); panel.classList.add('show'); panel.setAttribute('aria-hidden', 'false'); panel.focus(); openPanel = panel; } else { closeAllIndividualPanels(); }
            });
        });
        moreBtn.addEventListener('click', (e) => { e.stopPropagation(); const isExpanded = moreBtn.getAttribute('aria-expanded') === 'true'; if (!isExpanded) { expandedGroup.classList.add('show-expanded'); moreBtn.setAttribute('aria-expanded', 'true'); } else { expandedGroup.classList.remove('show-expanded'); moreBtn.setAttribute('aria-expanded', 'false'); closeAllIndividualPanels(); } });
        document.addEventListener('mousedown', (e) => { if (expandedGroup.classList.contains('show-expanded') && !expandedGroup.contains(e.target) && !moreBtn.contains(e.target)) { expandedGroup.classList.remove('show-expanded'); moreBtn.setAttribute('aria-expanded', 'false'); closeAllIndividualPanels(); } else if (openPanel && !openPanel.contains(e.target) && !buttons.some(({ btnId }) => document.getElementById(btnId).contains(e.target))) { closeAllIndividualPanels(); } });
        document.getElementById('copyrightYear').textContent = new Date().getFullYear();
        
            // ** NEW ** Logic for shrinking the header on scroll
        const header = document.getElementById('appHeader');
        const scrollablePanels = document.querySelectorAll('.tab-panel');
        
        scrollablePanels.forEach(panel => {
            panel.addEventListener('scroll', () => {
                if (panel.scrollTop > 50) {
                    header.classList.add('header-shrink');
                    tabHeaderState[panel.id] = true; // Save state: this panel is shrunk
                } else {
                    header.classList.remove('header-shrink');
                    tabHeaderState[panel.id] = false; // Save state: this panel is expanded
                }
            });
        });
    
        // Feedback form submission
        document.getElementById('feedbackForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const feedbackMessage = document.getElementById('feedbackMessage');
            const bugEncountered = e.target.bugEncountered.value;
            if (!bugEncountered) { feedbackMessage.style.color = 'red'; feedbackMessage.textContent = 'Please select Yes or No.'; return; }
            const formData = { bugEncountered: bugEncountered, bugDetails: e.target.bugDetails.value.trim(), suggestions: e.target.suggestions.value.trim() };
            e.target.querySelector('button[type="submit"]').disabled = true;
            feedbackMessage.style.color = 'black';
            feedbackMessage.textContent = 'Submitting...';
            fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'submitFeedback', data: formData })
                })
                .then(response => response.json())
                .then(response => {
                    if (response.status === 'success') {
                        feedbackMessage.style.color = 'green';
                        feedbackMessage.textContent = 'Thank you for your feedback!';
                        e.target.reset();
                    } else { throw new Error(response.message || 'Unknown error'); }
                })
                .catch(err => {
                    feedbackMessage.style.color = 'red';
                    feedbackMessage.textContent = 'Error: ' + err.message;
                })
                .finally(() => {
                    e.target.querySelector('button[type="submit"]').disabled = false;
                });
        });
    
        // Charger button and form logic
        const chargerButtons = document.querySelectorAll('.charger-btn');
        const chargerInput = document.getElementById('charger');
        chargerButtons.forEach(btn => btn.addEventListener('click', function() { chargerButtons.forEach(b => b.classList.remove('selected')); this.classList.add('selected'); 
        chargerInput.value = this.getAttribute('data-charger'); }));
        
        // Load user info from IndexedDB
        populateFormWithStoredUserInfo();
    
        // Initial setup
        const now = new Date();
        const ms = 1000 * 60 * 30;
        const roundedNow = new Date(Math.ceil(now.getTime() / ms) * ms);
        const plusOneHour = new Date(roundedNow.getTime() + 60 * 60 * 1000);
        
        // Initial data load and periodic updates
        loadBookings();
        setupFilterButtons();
        setInterval(updateChargerStatus, 1 * 1000);
    });

    function showMessage(type, message) {
        const errorDiv = document.getElementById('errorMsg');
        const successDiv = document.getElementById('successMsg');
    
        if (type === 'success') {
            successDiv.textContent = message;
            errorDiv.style.display = 'none';
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 10000);
    
        } else {
            errorDiv.textContent = message;
            successDiv.style.display = 'none';
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 10000);
        }
    }

    function showEventDetails(event) {
        const modal = document.getElementById('eventModal');
        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'Asia/Kuala_Lumpur' };
        document.getElementById('modalTitle').textContent = event.title;
        document.getElementById('modalContent').textContent = `Charger: ${event.extendedProps.charger}\nStart: ${new Date(event.start).toLocaleString('en-US', options)}\nEnd: ${new Date(event.end).toLocaleString('en-US', options)}\nCar Plate: ${event.extendedProps.plate}`;
        modal.style.display = 'flex';
    }
    document.getElementById('closeModal').addEventListener('click', () => document.getElementById('eventModal').style.display = 'none');
    document.getElementById('eventModal').addEventListener('click', e => { if (e.target.id === 'eventModal') document.getElementById('eventModal').style.display = 'none'; });

    function convertToTitleCase(input) { input.value = input.value.toLowerCase().replace(/\b\w/g, char => char.toUpperCase()); }

    // loadBookings - REFACTORED to use fetch()
	async function loadBookings() {
        console.groupCollapsed(`[Booking Loader] Starting update @ ${new Date().toLocaleTimeString()}`);
        let cachedEvents = [];
        try {
            console.log('Step 1: Loading from IndexedDB...');
            cachedEvents = await loadEventsFromIDB();
            if (cachedEvents && cachedEvents.length > 0) {
                console.info(`%cSuccess: Loaded ${cachedEvents.length} events from cache.`, 'color: green;');
                allEvents = cachedEvents;
                renderCalendar(allEvents);
                updateChargerStatus();
            } else { 
                console.warn('No cached events found.'); 
            }
        } catch (err) {
            console.error('Error loading from IndexedDB:', err);
            showMessage('error', 'Error loading cached bookings.');
            console.groupEnd(); // End group immediately on critical cache error
            return;
        }

        console.log('Step 2: Fetching from server...');
        fetch(`${WEB_APP_URL}?action=getBookings`)
            .then(response => {
                if (!response.ok) {
                    // If response is not 2xx, throw an error to be caught by .catch()
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                return response.json();
            })
            .then(async serverResponse => {
                console.group('[Server Response]');
                if (serverResponse.status !== 'success') {
                    throw new Error(serverResponse.message || 'Server returned an error status.');
                }
                const eventsFromServer = serverResponse.data;
                console.info(`Success: Received ${eventsFromServer.length} events.`);

                const serverIds = eventsFromServer.map(e => e.id).sort().join(',');
                const cachedIds = cachedEvents.map(e => e.id).sort().join(',');

                if (serverIds !== cachedIds) {
                    console.info('%cChange detected. Updating local data.', 'color: blue; font-weight: bold;');
                    allEvents = eventsFromServer;
                    await saveEventsToIDB(eventsFromServer);
                    console.info(`%cSaved ${eventsFromServer.length} new events to IndexedDB.`, 'color: green;');
                    renderCalendar(allEvents);
                    updateChargerStatus();
                } else { 
                    console.log('No changes detected.'); 
                }
                console.groupEnd(); // Closes [Server Response] group
            })
            .catch(err => {
                console.error('Server load failed:', err.message || err);
                if (allEvents.length === 0) {
                    showMessage('error', 'Could not load calendar: ' + err.message);
                }
            })
            .finally(() => {
                // This block runs regardless of success or failure.
                // It's the perfect place to close the main console group.
                console.groupEnd(); // Closes [Booking Loader] group
            });
    }

    function renderCalendar(events) {
                const calendarEl = document.getElementById('calendar');
                if (calendar) { calendar.removeAllEvents(); calendar.addEventSource(events); return; }
                const isMobile = window.innerWidth <= 768;
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'timeGridWeek', allDaySlot: false, stickyHeaderDates: true, timeZone: 'local', firstDay: 1, nowIndicator: true,
                    editable: false, longPressDelay: 9999, selectable: false,
                    headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
                    events: events, contentHeight: isMobile ? 'auto' : 'auto', scrollTimeReset: false,
                    eventClick: info => showEventDetails(info.event),
                    eventContent: arg => ({ html: `<div class="fc-event-main-frame"><div class="fc-event-title-container" style="font-weight:bold;"><div class="fc-event-title fc-sticky" style="color:#FFF;">${arg.event.title}</div><div style="font-size:0.85em; color:#FFF;">${arg.event.extendedProps.charger}</div></div></div>` })
                });
                calendar.render();
                calendarEl.style.touchAction = 'pan-y';
                setTimeout(() => calendarEl.querySelectorAll('.fc-view-harness, .fc-scroller, .fc-timegrid-body').forEach(el => el.style.touchAction = 'pan-y'), 100);
                const calendarHammer = new Hammer(calendarEl, { touchAction: 'pan-y' });
                calendarHammer.on('swipeleft', e => { e.srcEvent.stopPropagation(); calendar.next(); });
                calendarHammer.on('swiperight', e => { e.srcEvent.stopPropagation(); calendar.prev(); });
            }
        
            function updateChargerStatus() {
            const chargers = {
                'Tower A': { elementId: 'statusTowerA' },
                'Tower B': { elementId: 'statusTowerB' },
                'North 1': { elementId: 'statusNorth1' },
                'North 2': { elementId: 'statusNorth2' },
                'Clubhouse': { elementId: 'statusClubhouse' }
            };
        
            const statusMap = Object.keys(chargers).reduce((acc, name) => ({ ...acc, [name]: { occupied: false, event: null, upcomingEvent: null } }), {});
            const now = new Date();
        
            allEvents.forEach(event => {
                const charger = event.extendedProps.charger;
                if (!statusMap[charger]) return;
                const start = new Date(event.start);
                const end = new Date(event.end);
                if (now >= start && now < end) {
                    statusMap[charger].occupied = true;
                    statusMap[charger].event = event;
                } else if (start > now && (!statusMap[charger].upcomingEvent || new Date(statusMap[charger].upcomingEvent.start) > start)) {
                    statusMap[charger].upcomingEvent = event;
                }
            });
        
            Object.entries(statusMap).forEach(([chargerName, status]) => {
                const div = document.getElementById(chargers[chargerName].elementId);
                if (!div) return;
                
                let html = '';
                const upcomingHtml = generateUpcomingHtml(status.upcomingEvent, now);
                
                if (status.occupied) {
                    const event = status.event;
                    const start = new Date(event.start);
                    const end = new Date(event.end);
        
                    // THE FIX IS HERE: Define and use the same detailed formatting options
                    const dateTimeOptions = {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: 'numeric', minute: '2-digit', hour12: true
                    };
                    const startStr = start.toLocaleString('en-GB', dateTimeOptions).replace(',', '');
                    const endStr = end.toLocaleString('en-GB', dateTimeOptions).replace(',', '');
                    
                    const totalDuration = end - start;
                    const elapsedDuration = now - start;
                    const progress = Math.min(100, Math.max(0, (elapsedDuration / totalDuration) * 100));
                    
                    const remainingMs = end - now;
                    const remainingMinutes = Math.floor(remainingMs / 60000);
                    const hoursLeft = Math.floor(remainingMinutes / 60);
                    const minutesLeft = remainingMinutes % 60;
                    const timeLeftText = remainingMs > 0 ? (hoursLeft > 0 ? `${hoursLeft}h ${minutesLeft}m left` : `${minutesLeft}m left`) : 'Ending soon';
        
                    html = `
                        <div class="charger-status-item occupied">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong>${chargerName}</strong>
                                <span style="font-size: 0.80em; font-weight: bold; color: #1e2128;">${timeLeftText}</span>
                            </div>
                            <span class="status-text">
                                <b>Charging</b><br>
                                ${event.title}<br>
                                <small>${startStr} to ${endStr}</small>
                            </span>
                            <div class="progress-bar-container">
                                <div class="progress-bar active" style="width:${progress}%;"></div>
                            </div>
                            ${upcomingHtml}
                        </div>
                    `;
                } else {
                    html = `
                        <div class="charger-status-item ${status.upcomingEvent ? 'upcoming' : 'vacant'}">
                            <strong>${chargerName}</strong>
                            <span class="status-text"><strong>Vacant</strong></span>
                            ${upcomingHtml}
                        </div>
                    `;
                }
                
                if (div.innerHTML !== html) {
                    div.innerHTML = html;
                }
            });
        }
    
        function generateUpcomingHtml(event, now) {
        // If there is no upcoming event, return an empty string.
        if (!event) return '';
    
        const start = new Date(event.start);
        const end = new Date(event.end);
        
        // Define formatting options to match the image: dd/mm/yyyy, hh:mm am/pm
        const dateTimeOptions = {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: 'numeric', minute: '2-digit', hour12: true
        };
    
        // Format the start and end strings
        const startStr = start.toLocaleString('en-GB', dateTimeOptions).replace(',', '');
        const endStr = end.toLocaleString('en-GB', dateTimeOptions).replace(',', '');
    
        // Calculate the "Starts in..." countdown text
        let startsInText = '';
        const timeUntilStart = start.getTime() - now.getTime();
    
        if (timeUntilStart > 0) {
            const totalMinutes = Math.floor(timeUntilStart / (1000 * 60));
            const days = Math.floor(totalMinutes / (60 * 24));
            const hours = Math.floor((totalMinutes % (60 * 24)) / 60);
            const minutes = totalMinutes % 60;
            
            // Build the countdown string based on how much time is left
            if (days > 0) {
                startsInText = `Starts in ${days}d ${hours}h ${minutes}m`;
            } else if (hours > 0) {
                startsInText = `Starts in ${hours}h ${minutes}m`;
            } else {
                startsInText = `Starts in ${minutes}m`;
            }
        } else {
            startsInText = 'Starting soon';
        }
    
        // Construct the final HTML, matching the structure and styling from your image
        return `
            <div class="upcoming-session">
                <strong>Upcoming Session</strong><br>
                <span class="status-text">
                    ${event.title}<br>
                    <small>${startStr} to ${endStr}</small><br>
                    <span class="starts-in">${startsInText}</span>
                </span>
            </div>
        `;
    }

    function filterEventsByCharger(charger) {
        if (!calendar) return;
        const filtered = (charger === 'all') ? allEvents : allEvents.filter(e => e.extendedProps.charger === charger);
        calendar.removeAllEvents(); calendar.addEventSource(filtered);
    }
    function setupFilterButtons() {
        const buttons = document.querySelectorAll('.filter-btn');
        buttons.forEach(btn => btn.addEventListener('click', () => { buttons.forEach(b => b.classList.remove('active')); btn.classList.add('active'); filterEventsByCharger(btn.dataset.charger); }));
    }

    // Booking form submission - REFACTORED to use fetch()
document.getElementById('bookingForm').addEventListener('submit', async function(ev) {
    ev.preventDefault();
    const submitBtn = ev.target.querySelector('button[type="submit"]');

    // --- START: New Prioritized Validation Logic ---
    const name = document.getElementById('name').value.trim();
    const plate = document.getElementById('plate').value.trim();
    const email = document.getElementById('email').value.trim();
    const charger = document.getElementById('charger').value;
    const startValue = document.getElementById('start_datetime').value;
    
    // Priority 1: User Details
    if (!name) {
        showMessage('error', 'Please enter the Name of Car Owner.');
        return; // Stop
    }
    if (!plate) {
        showMessage('error', 'Please enter the Car Plate Number.');
        return; // Stop
    }
    if (!email) {
        showMessage('error', 'Please enter your Email Address for confirmation.');
        return; // Stop
    }

    // Priority 2: Charger Selection
    if (!charger) {
        showMessage('error', 'Please select a Charger Location.');
        return; // Stop
    }

    // Priority 3: Date and Time Selection
    if (!startValue) { // We only need to check one, as they are set together
        showMessage('error', 'Please select a Start and End Date and Time.');
        return; // Stop
    }
    
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Processing...';
    submitBtn.disabled = true;

    const data = {
        name: name,
        plate: plate,
        phone: document.getElementById('phone').value.trim(), // Phone is optional, no validation needed
        email: email,
        charger: charger,
        start_datetime: startValue,
        end_datetime: document.getElementById('end_datetime').value
    };

    if (new Date(data.end_datetime) <= new Date(data.start_datetime)) {
        showMessage('error', 'End date/time must be after start date/time.');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return;
    }

    const remember = document.getElementById('rememberMe').checked;
    if (remember) {
        await saveUserInfo('name', data.name);
        await saveUserInfo('email', data.email);
        await saveUserInfo('phone', data.phone);
        await saveUserInfo('plate', data.plate);
        await saveUserInfo('rememberMe', true);
    } else {
      await clearUserInfo();
    }

    fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({
            action: 'book',
            data: data
        })
    })
    .then(res => res.json())
    .then(async (res) => {
        if (res.status === 'success' && res.newEvent) {
            ev.target.reset();
            document.getElementById('start_display').value = '';
            document.getElementById('end_display').value = '';
            document.querySelectorAll('#bookingForm .charger-btn.selected').forEach(btn => btn.classList.remove('selected'));
            
            showMessage('success', res.message);
            
            allEvents.push(res.newEvent);
            await saveEventsToIDB(allEvents);
            renderCalendar(allEvents);
            updateChargerStatus();
            
            const bookingDate = new Date(data.start_datetime);
            calendar.gotoDate(bookingDate);
        } else {
            showMessage('error', res.message || 'Unknown error occurred');
        }
    })
    .catch(err => {
        showMessage('error', 'Reservation failed: ' + (err.message || 'Unknown error'));
    })
    .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
});

    function toDatetimeLocal(dt, tz) {
        const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false, timeZone: tz };
        const parts = new Intl.DateTimeFormat('en-US', options).formatToParts(dt).reduce((acc, part) => ({ ...acc, [part.type]: part.value }), {});
        return `${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}`;
    }
    
    
    /* =================================================================
       INDEXEDDB CACHING LOGIC (Unchanged, now in the correct context)
       ================================================================= */
    const dbName = 'EVChargerDB'; const dbVersion = 2; let db;
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(dbName, dbVersion);
        request.onupgradeneeded = e => { db = e.target.result; if (!db.objectStoreNames.contains('bookings')) db.createObjectStore('bookings', { keyPath: 'id' }); if (!db.objectStoreNames.contains('userinfo')) db.createObjectStore('userinfo', { keyPath: 'key' }); };
        request.onsuccess = e => { db = e.target.result; resolve(db); };
        request.onerror = e => reject('IndexedDB error: ' + e.target.errorCode);
      });
    }
    async function saveEventsToIDB(events) { const db = await openDB(); const tx = db.transaction('bookings', 'readwrite'); tx.objectStore('bookings').clear(); events.forEach(event => { if (event.id) tx.objectStore('bookings').put(event); }); return tx.complete; }
        async function loadEventsFromIDB() {
      const db = await openDB();
      const request = db.transaction('bookings', 'readonly').objectStore('bookings').getAll();
      
      return new Promise((resolve, reject) => {
        request.onsuccess = () => {
          // Ensure we always resolve with an array, even if the result is empty or undefined
          resolve(request.result || []); 
        };
        request.onerror = (event) => {
          console.error("Failed to load from IDB:", event.target.error);
          // Reject the promise on error
          reject(event.target.error);
        };
      });
    }
    async function saveUserInfo(key, value) { const db = await openDB(); return db.transaction('userinfo', 'readwrite').objectStore('userinfo').put({ key, value }); }
    async function loadUserInfo(key) { const db = await openDB(); const request = db.transaction('userinfo', 'readonly').objectStore('userinfo').get(key); return new Promise(resolve => { request.onsuccess = () => resolve(request.result?.value ?? null); }); }
    async function clearUserInfo() { const db = await openDB(); return db.transaction('userinfo', 'readwrite').objectStore('userinfo').clear(); }
    async function populateFormWithStoredUserInfo() { if (await loadUserInfo('rememberMe')) { document.getElementById('rememberMe').checked = true; document.getElementById('name').value = await loadUserInfo('name') || ''; document.getElementById('phone').value = await loadUserInfo('phone') || ''; document.getElementById('email').value = await loadUserInfo('email') || ''; document.getElementById('plate').value = await loadUserInfo('plate') || ''; console.log('Loaded user info from IndexedDB.'); } }


    /* =================================================================
       PWA & FIREBASE LOGIC (from original github.io file)
       ================================================================= */
    if ('serviceWorker' in navigator) {
      // We don't need the 'refreshing' flag anymore.
      navigator.serviceWorker.register('/service-worker.js').then(reg => {
        reg.addEventListener('updatefound', () => {
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            // This condition is the same: a new worker is ready and an old one is active.
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              const toast = document.getElementById('updateToast');
              if (toast) {
                toast.style.display = 'block';
                
                // SIMPLIFIED ONCLICK HANDLER:
                // Its only job is to tell the new worker to take over.
                document.getElementById('refreshBtn').onclick = () => {
                  toast.style.display = 'none'; // Hide the button immediately
                  newWorker.postMessage({ action: 'skipWaiting' });
                };
              }
            }
          });
        });
      }).catch(err => console.error('SW registration failed:', err));
    
      // THE KEY CHANGE IS HERE:
      // We listen for when the new worker has taken control.
      // When it does, we reload the page unconditionally to get the new assets.
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        console.log('SW Controller changed! Reloading page...');
        window.location.reload();
      });
    }

    // Firebase for live notifications
    document.addEventListener('DOMContentLoaded', () => {
      const updateBanner = document.getElementById('update-notification');
      const hammer = new Hammer(updateBanner);
      hammer.get('swipe').set({ direction: Hammer.DIRECTION_VERTICAL });
      hammer.on('swipeup swipedown', () => { updateBanner.style.display = 'none'; });
      const firebaseConfig = {
        apiKey: "AIzaSyBgry0qgmprMVXk0svD8sPX-wqLnH6m80U",
        authDomain: "bookingsync-94975.firebaseapp.com",
        databaseURL: "https://bookingsync-94975-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "bookingsync-94975",
        storageBucket: "bookingsync-94975.firebasestorage.app",
        messagingSenderId: "941285031936",
        appId: "1:941285031936:web:5fbb2e3ef9ff730e4e98e5"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      let lastSeenTimestamp = null;
      db.ref('server/lastUpdate').on('value', (snapshot) => {
        const timestamp = snapshot.val();
        if (!timestamp) return;
        if (lastSeenTimestamp === null) { lastSeenTimestamp = timestamp; return; }
        if (timestamp !== lastSeenTimestamp) {
          lastSeenTimestamp = timestamp;
          updateBanner.style.display = 'block';
        }
      });
      window.refreshPage = () => { window.location.reload(); };
    });
  </script>
  
      // timepickr and nouislider 
    <div id="dateTimePickerModal" class="modal-overlay" style="display: none;">
      <div class="modal-content">
          <button id="closeDateTimePicker" class="close-button">&times;</button>
          <h2>Select Date & Time</h2>
          <div class="calendar-wrapper">
              <div id="date-calendar"></div>
          </div>
          <div class="time-selector-group">
              <label>Start Time: <span id="start-time-value"></span></label>
              <div id="start-time-slider" class="time-slider"></div>
          </div>
          <div class="time-selector-group">
              <label>End Time: <span id="end-time-value"></span></label>
              <div id="end-time-slider" class="time-slider"></div>
          </div>
          <div class="summary-display">
              <div id="summary-text" class="summary-placeholder">Select the start and end date</div>
          </div>
          <!-- These hidden inputs are temporary storage for the modal -->
          <input type="hidden" id="dtp_start_datetime">
          <input type="hidden" id="dtp_end_datetime">
          <button id="apply-button" class="apply-button" disabled>CONFIRM</button>
      </div>
    </div>
</body>
</html>
