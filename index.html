<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Emerald Hills EV Charger Reservation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <link rel="manifest" href="/assets/images/favicons/site.webmanifest">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicons/favicon-16x16.png">
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">

  <style>
    /* ... your CSS ... */
    .iframe-wrapper {
        width: 100%;
        display: flex;
        flex-direction: column;
        min-height: 100vh; /* fallback */
    }

    @supports (height: 100dvh) {
        .iframe-wrapper {
            min-height: 100dvh; /* safari & modern browsers */
            padding-bottom: env(safe-area-inset-bottom, 1px); /* ðŸ‘ˆ Ensures iframe isn't cut off */
        }
    }

    iframe {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
        flex-grow: 1;
    }

    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: 'Poppins', Arial, sans-serif;
        background-color: #ffffff;
        color: #545454;
        display: flex;
        flex-direction: column;
        padding-bottom: env(safe-area-inset-bottom, 1px); /* ðŸ‘ˆ Adds safe space at bottom */
    }

    #installBtn {
        position: static;
        top: 10px;
        left: 10px;
        background-color: #007bff;
        color: white;
        padding: 10px 14px;
        border: none;
        border-radius: 8px 8px 0px 0px;
        font-family: 'Poppins', Arial, sans-serif;
        font-size: 16px;
        cursor: pointer;
        z-index: 1000;
        display: none;
    }

    #update-notification {
        display: none;
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(100%);
        background: #fffbe6;
        border: 1px solid #ffecb3;
        background: #fff7df;
        border: 1px solid #fff7df;
        padding: 16px 20px;
        text-align: center;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        z-index: 1000;
        animation: slideIn 0.4s forwards;
    }

    #update-notification p {
        margin: 0;
        font-size: 16px;
        font-size: 14px;
        color: #333;
    }

    #update-notification button {
        margin-top: 10px;
        padding: 8px 16px;
        background-color: #007bff;
        background-color: #378fee;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-size: 12px;
        cursor: pointer;
    }

    @keyframes slideIn {
        to {
            transform: translateX(-50%) translateY(0%);
        }
    }
  </style>
</head>
<body>
  <div class="iframe-wrapper">
    <iframe
      id="booking-frame"
      src="" title="Emerald Hills EV Charger Booking"
      sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-pointer-lock allow-downloads">
    </iframe>
  </div>

  <div id="update-notification">
    <p>ðŸ”” A new booking has been added.</p>
    <button onclick="refreshIframe()">Update Calendar</button>
  </div>


  <div id="updateToast" style="
    display: none;
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #333;
    color: #fff;
    padding: 14px 24px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    z-index: 1000;
    font-family: sans-serif;
    text-align: center;
    max-width: 90vw;
    box-sizing: border-box;
  ">
    <div style="margin-bottom: 8px; white-space: nowrap;">ðŸ”„ New version available</div>
    <button id="refreshBtn" style="
      padding: 6px 12px;
      background-color: #4CAF50;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    ">Update Now</button>
  </div>

  <button id="installBtn">Install App</button>
  <button id="updateAppBtn" style="display: none;">ðŸ”„ New version available. Click to update.</button>

  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      let refreshing = false;
      let newWorker = null;

      navigator.serviceWorker.register('/service-worker.js').then(reg => {
        console.log('SW registered:', reg);

        reg.addEventListener('updatefound', () => {
          newWorker = reg.installing;
          console.log('New SW found, installing...');

          newWorker.addEventListener('statechange', () => {
            console.log('SW state changed to:', newWorker.state);

            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              console.log('New SW installed, showing update toast');
              // Show toast when update is available
              const toast = document.getElementById('updateToast');
              if (toast) {
                toast.style.display = 'block';

                // Remove any existing event listeners to prevent duplicates
                const refreshBtn = document.getElementById('refreshBtn');
                const newRefreshBtn = refreshBtn.cloneNode(true);
                refreshBtn.parentNode.replaceChild(newRefreshBtn, refreshBtn);

                // Add click handler for update button
                newRefreshBtn.addEventListener('click', async () => {
                  console.log('User clicked refresh button');

                  try {
                    // Clear cache
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                    console.log('Caches cleared');

                    // Set reload flag before triggering skipWaiting
                    refreshing = true;

                    // Hide toast
                    toast.style.display = 'none';

                    // Skip waiting - send message to the waiting service worker
                    if (newWorker) {
                      newWorker.postMessage({ action: 'skipWaiting' });
                    } else {
                      // Fallback: send to current controller
                      navigator.serviceWorker.controller?.postMessage({ action: 'skipWaiting' });
                    }
                  } catch (error) {
                    console.error('Error during update process:', error);
                    // Reset flag if error occurs
                    refreshing = false;
                  }
                });
              }
            }
          });
        });
      }).catch(err => {
        console.error('SW registration failed:', err);
      });

      // Reload page when new SW takes control
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        console.log('Controller changed, refreshing flag:', refreshing);

        if (refreshing) {
          console.log('Reloading page...');
          window.location.reload();
        }
      });
    }

    // Resize iframe dynamically if needed
    window.addEventListener('message', function(event) {
      if (event.data && event.data.type === 'iframeHeight') {
        const iframeElement = document.querySelector('iframe');
        if (iframeElement) {
          iframeElement.style.height = (event.data.height + 50) + 'px';
        }
      }
    });

    // Handle install prompt
    window.addEventListener('DOMContentLoaded', () => { // Keep this DOMContentLoaded for PWA install prompt
      let deferredPrompt;

      const installBtn = document.getElementById('installBtn');

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.style.display = 'inline-block';

        installBtn.addEventListener('click', () => {
          installBtn.style.display = 'none';
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then(choice => {
            console.log(choice.outcome);
            deferredPrompt = null;
          });
        }, { once: true });
      });

      /* Detect iOS Safari + Set Dynamic Height via JS */
      function isIOS() {
        return /iPad|iPhone|iPod/.test(navigator.platform) ||
              (navigator.userAgent.includes("Mac") && "ontouchend" in document);
      }

      function isSafari() {
        return /^((?!chrome|android).)*safari/i.test(navigator.userAgent) &&
              navigator.vendor && navigator.vendor.includes("Apple");
      }

      function adjustIframeHeight() {
        if (isIOS() && isSafari()) {
          const iframe = document.querySelector('iframe');
          if (iframe) {
            iframe.style.height = `${window.innerHeight}px`;
          }
        }
      }

      window.addEventListener('resize', adjustIframeHeight);
      window.addEventListener('orientationchange', adjustIframeHeight);
      document.addEventListener('DOMContentLoaded', adjustIframeHeight); // This was already here, but good.


      // --- Start of Consolidated Firebase & Notification Logic (moved inside DOMContentLoaded) ---

      const firebaseConfig = {
        apiKey: "AIzaSyAlb8aLl1kRafLO7GY5rarVly-Z1wMDbz0",
        authDomain: "bookingsync-ff9bd.firebaseapp.com",
        databaseURL: "https://bookingsync-ff9bd-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "bookingsync-ff9bd",
        storageBucket: "bookingsync-ff9bd.appspot.com",
        messagingSenderId: "269992391466",
        appId: "1:269992391466:web:b65bc168c948de21796453"
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      function getClientId() {
          let clientId = localStorage.getItem('ev_charger_client_id');
          if (!clientId) {
              clientId = 'client_gh_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
              localStorage.setItem('ev_charger_client_id', clientId);
          }
          return clientId;
      }

      const currentClientId = getClientId(); // This is the ID of the GitHub Pages container
      console.log('GitHub Pages Client ID:', currentClientId);

      // MODIFIED: Construct the iframe URL with the currentClientId as a parameter AFTER DOMContentLoaded
      const iframeBaseUrl = "https://script.google.com/macros/s/AKfycbz_ogm5OeRnRs69SYg8ZUjO_hCkn5K_jcEzver5a2Zo_in1BIX1RUfuV9H9fZI2jh5p/exec";
      const iframeElement = document.getElementById('booking-frame');
      iframeElement.src = `${iframeBaseUrl}?parentId=${currentClientId}`;


      let lastSeenTimestamp = null;

      // MODIFIED: Variable to hold the iframe's client ID obtained from Firebase (specific to this parent)
      let actualBookingSourceClientId = currentClientId; // Initialize with parent's ID as fallback

      // MODIFIED: Firebase listener to get the iframe's client ID, specific to this parent
      db.ref(`clients_map/${currentClientId}/iframeClientId`).on('value', (snapshot) => {
          const iframeFirebaseClientId = snapshot.val();
          if (iframeFirebaseClientId) {
              actualBookingSourceClientId = iframeFirebaseClientId;
              console.log('Received iframe Client ID from Firebase (specific to this parent):', actualBookingSourceClientId);
          }
      });

      // Function to display the notification banner
      function showUpdateNotification() {
          const updateBanner = document.getElementById('update-notification');
          if (updateBanner) {
              updateBanner.style.display = 'block';
          }
      }

      // Function to refresh the iframe content
      function refreshIframe() {
          const iframe = document.getElementById('booking-frame');
          if (iframe) {
              iframe.src = iframe.src; // Reloads the iframe
              const updateBanner = document.getElementById('update-notification');
              if (updateBanner) {
                  updateBanner.style.display = 'none'; // Hide notification after refresh
              }
          }
      }

      // Assign the refreshIframe function to the global scope for the button's onclick
      window.refreshIframe = refreshIframe;

      // Firebase listener for booking updates
      db.ref('server/lastUpdateDetails').on('value', (snapshot) => {
          const data = snapshot.val(); // Get the entire object
          if (!data || !data.timestamp) return; // Ensure data and timestamp exist

          const timestamp = data.timestamp;
          const bookingClientId = data.clientId; // Get the client ID from the booking

          if (lastSeenTimestamp === null) {
              lastSeenTimestamp = timestamp;
              return; // First load â€“ no notification
          }

          // Only show notification if the timestamp has changed AND
          // the booking was NOT made by this device
          if (timestamp !== lastSeenTimestamp) {
              lastSeenTimestamp = timestamp;
              console.log("ðŸŒŸ New booking detected:", new Date(timestamp), "Booker Client ID:", bookingClientId);

              // MODIFIED: Use actualBookingSourceClientId for comparison
              if (bookingClientId && bookingClientId === actualBookingSourceClientId) {
                  console.log("ðŸš« Notification suppressed: Booking made by this device.");
              } else {
                  // Display notification to all other devices
                  showUpdateNotification();
                  console.log("âœ… Notification displayed: Booking made by another device.");
              }
          }
      });

      // --- End of Consolidated Firebase & Notification Logic ---

    }); // End of DOMContentLoaded listener
  </script>

</body>
</html>